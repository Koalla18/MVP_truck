<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RoutoX — Маршрутизация</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <script src="https://kit.fontawesome.com/a2e0e9e5a9.js" crossorigin="anonymous"></script>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="./assets/css/routox-unified.css">
  <link rel="stylesheet" href="./assets/css/page-transitions.css">
  <style>
    body {
        font-family: "Inter", sans-serif;
        background-color: #FFF8F0;
        background-image: 
            radial-gradient(at 0% 0%, hsla(30,100%,96%,1) 0, transparent 50%), 
            radial-gradient(at 100% 0%, hsla(35,100%,96%,1) 0, transparent 50%), 
            radial-gradient(at 100% 100%, hsla(40,100%,96%,1) 0, transparent 50%);
    }
    .glass-panel {
        background: rgba(255, 255, 255, 0.75);
        backdrop-filter: blur(20px);
        border: 1px solid rgba(255, 255, 255, 0.9);
        box-shadow: 0 8px 32px 0 rgba(245, 158, 11, 0.08);
        border-radius: 16px;
    }
    .glass-card {
        background: rgba(255, 255, 255, 0.85);
        backdrop-filter: blur(16px);
        border: 1px solid rgba(255, 255, 255, 0.7);
        box-shadow: 0 4px 20px rgba(245, 158, 11, 0.05);
        border-radius: 14px;
        transition: all 0.2s ease;
    }
    .glass-card:hover {
        background: rgba(255, 255, 255, 0.95);
        box-shadow: 0 10px 30px rgba(245, 158, 11, 0.12);
        transform: translateY(-2px);
    }
    .nav-item-active {
        background: rgba(255, 255, 255, 0.9);
        color: #f59e0b !important;
        box-shadow: 0 2px 10px rgba(245, 158, 11, 0.15);
        font-weight: 600 !important;
    }
    .btn-primary {
        background: linear-gradient(135deg, #f59e0b, #d97706);
        color: white;
        border: none;
        transition: all 0.2s ease;
    }
    .btn-primary:hover {
        background: linear-gradient(135deg, #d97706, #b45309);
        box-shadow: 0 8px 20px rgba(245, 158, 11, 0.25);
        transform: translateY(-1px);
    }
    .route-card {
        cursor: pointer;
        border-left: 4px solid #f59e0b;
    }
    .route-card:hover {
        border-left-color: #d97706;
    }
    .waypoint {
        position: relative;
        padding-left: 24px;
    }
    .waypoint::before {
        content: '';
        position: absolute;
        left: 7px;
        top: 10px;
        bottom: -10px;
        width: 2px;
        background: linear-gradient(180deg, #f59e0b, #fbbf24);
    }
    .waypoint:last-child::before {
        display: none;
    }
    .waypoint-icon {
        position: absolute;
        left: 0;
        top: 8px;
        width: 16px;
        height: 16px;
        background: white;
        border: 3px solid #f59e0b;
        border-radius: 50%;
    }
    .waypoint-icon.start {
        background: #10b981;
        border-color: #059669;
    }
    .waypoint-icon.end {
        background: #ef4444;
        border-color: #dc2626;
    }
    #routeMap {
        border-radius: 16px;
        z-index: 1;
    }
    .stat-card {
        background: linear-gradient(135deg, #fef3c7, #fde68a);
        border: 1px solid #fbbf24;
    }
    .optimization-badge {
        background: linear-gradient(135deg, #10b981, #059669);
        color: white;
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
    }
  </style>
</head>
<body class="bg-slate-50">

  <!-- Header -->
  <header class="sticky top-0 z-40 glass-panel border-b border-white/50 px-6 py-3">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-8">
        <a href="logist.html" class="flex items-center gap-3 group">
          <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-amber-500 to-orange-600 flex items-center justify-center shadow-lg group-hover:shadow-xl transition-shadow">
            <i class="fa-solid fa-truck-fast text-white text-lg"></i>
          </div>
          <div class="flex flex-col leading-none">
            <span class="text-lg font-bold bg-gradient-to-r from-amber-600 to-orange-600 bg-clip-text text-transparent">RoutoX</span>
            <span class="text-[10px] text-slate-500 font-medium">LOGIST</span>
          </div>
        </a>

        <nav class="hidden lg:flex items-center gap-1 bg-slate-100/50 p-1 rounded-xl">
          <a class="px-4 py-1.5 rounded-lg text-sm font-medium text-slate-500 hover:text-amber-800 hover:bg-white/60 transition-colors" href="logist.html">Заказы</a>
          <a class="px-4 py-1.5 rounded-lg text-sm font-semibold nav-item-active transition-all" href="routes.html">Маршруты</a>
          <a class="px-4 py-1.5 rounded-lg text-sm font-medium text-slate-500 hover:text-amber-800 hover:bg-white/60 transition-colors" href="trips.html">Рейсы</a>
          <a class="px-4 py-1.5 rounded-lg text-sm font-medium text-slate-500 hover:text-amber-800 hover:bg-white/60 transition-colors" href="drivers-manage.html">Водители</a>
          <a class="px-4 py-1.5 rounded-lg text-sm font-medium text-slate-500 hover:text-amber-800 hover:bg-white/60 transition-colors" href="clients.html">Клиенты</a>
          <a class="px-4 py-1.5 rounded-lg text-sm font-medium text-slate-500 hover:text-amber-800 hover:bg-white/60 transition-colors" href="warehouse.html">Склад</a>
          <a class="px-4 py-1.5 rounded-lg text-sm font-medium text-slate-500 hover:text-amber-800 hover:bg-white/60 transition-colors" href="loading-plan.html">Планирование</a>
          <a class="px-4 py-1.5 rounded-lg text-sm font-medium text-slate-500 hover:text-amber-800 hover:bg-white/60 transition-colors" href="delivery-stats.html">Статистика</a>
          <a class="px-4 py-1.5 rounded-lg text-sm font-medium text-slate-500 hover:text-amber-800 hover:bg-white/60 transition-colors" href="geozones.html">Геозоны</a>
        </nav>
      </div>

      <div class="flex items-center gap-3">
        <span class="hidden lg:flex items-center gap-2 px-3 py-1.5 bg-amber-50 border border-amber-200 rounded-full text-xs">
            <i class="fa-solid fa-route text-amber-600"></i>
            <span id="roleText" class="font-semibold text-amber-800">Логист</span>
        </span>
        <div class="flex items-center gap-3 pl-1 pr-1 py-1 bg-white/50 border border-white rounded-full shadow-sm hover:shadow-md transition-shadow cursor-pointer">
            <div class="w-8 h-8 rounded-full bg-slate-200 overflow-hidden ring-2 ring-white">
                <img alt="User" class="w-full h-full object-cover" src="https://lh3.googleusercontent.com/aida-public/AB6AXuCTs9iN8pKS03W5I54u9FB4B-c8kh0-SvddoYiVdknvnn0XFQ_ScxzcOGMuvCw75ZDO7eej3OBFSUyW7YGzfIdw8bm2JVE2qYntX-6WFsuWZDXeCjqgvXyR-Lo9UnAE2bTQejiaicaZNqXTEEWzBEmoalZytqScbtdaXlk0i5laN5yjsqI3j457keHzESRrW4bLeWD2l5xuer1uZ4Zd_LMeP8p-XTEa4_wtLTcRyHGOncDuMQUJk788z8tvDII7r8UTdnahdzzaAtY"/>
            </div>
            <div class="pr-3 flex flex-col items-end leading-none">
                <p class="text-xs font-bold text-slate-800" id="userName">Логист</p>
                <p class="text-[9px] text-amber-600 font-semibold mt-0.5" id="userRole">Pro</p>
            </div>
        </div>
        <button class="w-10 h-10 flex items-center justify-center text-slate-400 hover:text-slate-700 bg-white/50 hover:bg-white rounded-full transition-all shadow-sm border border-white/50 relative" title="Уведомления" onclick="window.location.href='notifications.html'">
            <span class="material-symbols-outlined text-[20px]">notifications</span>
            <span class="absolute top-2.5 right-2.5 w-2 h-2 bg-red-500 rounded-full ring-2 ring-white"></span>
        </button>
        <button class="w-10 h-10 flex items-center justify-center text-slate-400 hover:text-red-500 bg-white/50 hover:bg-white rounded-full transition-all shadow-sm border border-white/50" title="Выход" onclick="logout()">
            <span class="material-symbols-outlined text-[20px]">logout</span>
        </button>
      </div>
    </div>
  </header>

  <!-- Main Content -->
  <main class="p-4 grid grid-cols-12 gap-4" style="height: calc(100vh - 88px);">
    <!-- Left Panel - Routes List -->
    <aside class="col-span-4 space-y-4 overflow-hidden flex flex-col">
      <!-- Stats -->
      <div class="grid grid-cols-2 gap-3">
        <div class="stat-card p-3 rounded-xl">
          <div class="text-2xl font-bold text-amber-800">4</div>
          <div class="text-[10px] text-amber-700 font-medium mt-1">Активных маршрутов</div>
        </div>
        <div class="stat-card p-3 rounded-xl">
          <div class="text-2xl font-bold text-amber-800">1,245 км</div>
          <div class="text-[10px] text-amber-700 font-medium mt-1">Общая длина</div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="flex gap-2">
        <button onclick="createRoute()" class="flex-1 btn-primary py-2.5 rounded-xl text-sm font-medium shadow-lg">
          <i class="fa-solid fa-plus mr-2"></i>Создать маршрут
        </button>
        <button onclick="optimizeAll()" class="px-4 py-2.5 rounded-xl bg-emerald-500 hover:bg-emerald-600 text-white text-sm font-medium shadow-lg transition">
          <i class="fa-solid fa-wand-magic-sparkles"></i>
        </button>
      </div>

      <!-- Routes List -->
      <div class="glass-panel p-4 flex-1 overflow-y-auto">
        <h3 class="text-xs font-bold text-slate-500 mb-3 uppercase tracking-wide">Сегодняшние маршруты</h3>
        <div class="space-y-2" id="routesList"></div>
      </div>
    </aside>

    <!-- Center - Map -->
    <section class="col-span-5">
      <div class="glass-panel p-4 h-full flex flex-col">
        <div class="flex items-center justify-between mb-3">
          <h2 class="text-lg font-bold text-slate-800">Карта маршрутов</h2>
          <div class="flex gap-2">
            <button onclick="fitAllRoutes()" class="px-3 py-1.5 text-xs bg-white rounded-lg hover:bg-slate-50 transition">
              <i class="fa-solid fa-compress mr-1"></i>Все маршруты
            </button>
            <button onclick="toggleTraffic()" class="px-3 py-1.5 text-xs bg-white rounded-lg hover:bg-slate-50 transition">
              <i class="fa-solid fa-traffic-light mr-1"></i>Пробки
            </button>
          </div>
        </div>
        <div id="routeMap" class="flex-1 min-h-0"></div>
      </div>
    </section>

    <!-- Right Panel - Route Details -->
    <aside class="col-span-3 space-y-4 overflow-hidden flex flex-col">
      <div class="glass-panel p-4 flex-1 overflow-y-auto">
        <h3 class="text-sm font-bold text-slate-800 mb-4">Детали маршрута</h3>
        <div id="routeDetails"></div>
      </div>
    </aside>
  </main>

  <script src="./assets/js/routa-core.js"></script>
  <script>
    // Initialize Routa and theme
    Routa.Theme.load();

    // Demo routes data
    const routes = [
      {
        id: 1,
        name: 'МСК → СПб → НН',
        status: 'active',
        distance: 1340,
        duration: '18ч 20м',
        vehicle: 'А001АА77',
        driver: 'Иванов П.',
        orders: 3,
        waypoints: [
          { name: 'Москва, склад №1', lat: 55.7558, lng: 37.6173, type: 'start', time: '06:00' },
          { name: 'Санкт-Петербург, ул. Ленина 45', lat: 59.9343, lng: 30.3351, type: 'stop', time: '15:30' },
          { name: 'Нижний Новгород, пр. Гагарина 12', lat: 56.2965, lng: 43.9361, type: 'end', time: '22:20' }
        ],
        optimized: true
      },
      {
        id: 2,
        name: 'Казань → Самара',
        status: 'planning',
        distance: 420,
        duration: '6ч 15м',
        vehicle: 'В002ВВ77',
        driver: 'Петров С.',
        orders: 2,
        waypoints: [
          { name: 'Казань, ТЦ Мега', lat: 55.8304, lng: 49.0661, type: 'start', time: '08:00' },
          { name: 'Самара, Московское шоссе 24', lat: 53.1950, lng: 50.1069, type: 'end', time: '14:15' }
        ],
        optimized: false
      },
      {
        id: 3,
        name: 'Екб → Челябинск → Уфа',
        status: 'active',
        distance: 625,
        duration: '9ч 40м',
        vehicle: 'С003СС77',
        driver: 'Сидоров А.',
        orders: 4,
        waypoints: [
          { name: 'Екатеринбург, Сибирский тракт 8', lat: 56.8389, lng: 60.6057, type: 'start', time: '07:00' },
          { name: 'Челябинск, ул. Труда 156', lat: 55.1644, lng: 61.4368, type: 'stop', time: '11:20' },
          { name: 'Уфа, Проспект Октября 71', lat: 54.7388, lng: 55.9721, type: 'end', time: '16:40' }
        ],
        optimized: true
      }
    ];

    let map = null;
    let selectedRouteId = null;
    let routeMarkers = [];
    let routePolylines = [];

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      initMap();
      renderRoutes();
      if (routes.length > 0) {
        selectRoute(routes[0].id);
      }
    });

    function initMap() {
      map = L.map('routeMap').setView([55.7558, 37.6173], 5);
      L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
        attribution: '© OpenStreetMap contributors © CARTO'
      }).addTo(map);

      drawAllRoutes();
    }

    function drawAllRoutes() {
      // Clear existing
      routeMarkers.forEach(m => map.removeLayer(m));
      routePolylines.forEach(p => map.removeLayer(p));
      routeMarkers = [];
      routePolylines = [];

      routes.forEach(route => {
        const coords = route.waypoints.map(w => [w.lat, w.lng]);
        
        // Draw polyline
        const polyline = L.polyline(coords, {
          color: route.status === 'active' ? '#f59e0b' : '#cbd5e1',
          weight: route.id === selectedRouteId ? 5 : 3,
          opacity: route.id === selectedRouteId ? 0.9 : 0.5
        }).addTo(map);
        routePolylines.push(polyline);

        // Draw waypoints
        route.waypoints.forEach((wp, idx) => {
          const color = wp.type === 'start' ? '#10b981' : wp.type === 'end' ? '#ef4444' : '#f59e0b';
          const marker = L.circleMarker([wp.lat, wp.lng], {
            radius: 8,
            fillColor: color,
            color: '#fff',
            weight: 2,
            fillOpacity: 0.9
          }).addTo(map);

          marker.bindPopup(`
            <div class="p-2">
              <div class="font-bold text-sm">${wp.name}</div>
              <div class="text-xs text-gray-500 mt-1">${wp.time} • ${route.name}</div>
            </div>
          `);

          routeMarkers.push(marker);
        });
      });
    }

    function renderRoutes() {
      const container = document.getElementById('routesList');
      container.innerHTML = routes.map(route => `
        <div class="route-card glass-card p-3 ${selectedRouteId === route.id ? 'ring-2 ring-amber-400' : ''}" onclick="selectRoute(${route.id})">
          <div class="flex items-start justify-between mb-2">
            <div class="flex-1">
              <div class="font-semibold text-sm text-slate-800">${route.name}</div>
              <div class="text-xs text-slate-500 mt-1">${route.vehicle} • ${route.driver}</div>
            </div>
            ${route.optimized ? '<div class="optimization-badge">Оптимизирован</div>' : ''}
          </div>
          <div class="grid grid-cols-2 gap-2 mt-3">
            <div class="bg-amber-50 p-2 rounded-lg">
              <div class="text-[10px] text-amber-700 font-medium">Расстояние</div>
              <div class="text-sm font-bold text-amber-800">${route.distance} км</div>
            </div>
            <div class="bg-amber-50 p-2 rounded-lg">
              <div class="text-[10px] text-amber-700 font-medium">Время</div>
              <div class="text-sm font-bold text-amber-800">${route.duration}</div>
            </div>
          </div>
          <div class="flex items-center gap-2 mt-3 pt-3 border-t border-slate-200">
            <span class="text-xs text-slate-600"><i class="fa-solid fa-box mr-1"></i>${route.orders} заказ${route.orders > 1 ? 'а' : ''}</span>
            <span class="text-xs px-2 py-1 rounded-full ${route.status === 'active' ? 'bg-green-100 text-green-700' : 'bg-blue-100 text-blue-700'}">
              ${route.status === 'active' ? 'В пути' : 'Планируется'}
            </span>
          </div>
        </div>
      `).join('');
    }

    function selectRoute(id) {
      selectedRouteId = id;
      renderRoutes();
      renderRouteDetails();
      drawAllRoutes();

      const route = routes.find(r => r.id === id);
      if (route && route.waypoints.length > 0) {
        const bounds = L.latLngBounds(route.waypoints.map(w => [w.lat, w.lng]));
        map.fitBounds(bounds, { padding: [50, 50] });
      }
    }

    function renderRouteDetails() {
      const container = document.getElementById('routeDetails');
      const route = routes.find(r => r.id === selectedRouteId);

      if (!route) {
        container.innerHTML = '<p class="text-sm text-slate-400 text-center py-10">Выберите маршрут</p>';
        return;
      }

      container.innerHTML = `
        <div class="space-y-4">
          <div>
            <div class="text-xs text-slate-500 font-medium mb-2">ТС и водитель</div>
            <div class="glass-card p-3 flex items-center gap-3">
              <div class="w-10 h-10 rounded-lg bg-amber-100 flex items-center justify-center">
                <i class="fa-solid fa-truck text-amber-600"></i>
              </div>
              <div>
                <div class="text-sm font-semibold">${route.vehicle}</div>
                <div class="text-xs text-slate-500">${route.driver}</div>
              </div>
            </div>
          </div>

          <div>
            <div class="text-xs text-slate-500 font-medium mb-2">Маршрут</div>
            <div class="space-y-2">
              ${route.waypoints.map(wp => `
                <div class="waypoint">
                  <div class="waypoint-icon ${wp.type}"></div>
                  <div class="pl-3">
                    <div class="text-xs font-semibold text-slate-800">${wp.name}</div>
                    <div class="text-[11px] text-slate-500">${wp.time}</div>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>

          <div class="grid grid-cols-2 gap-2">
            <button class="btn-primary py-2 rounded-lg text-xs font-medium">
              <i class="fa-solid fa-edit mr-1"></i>Изменить
            </button>
            <button class="py-2 rounded-lg bg-emerald-500 hover:bg-emerald-600 text-white text-xs font-medium transition">
              <i class="fa-solid fa-play mr-1"></i>Начать
            </button>
          </div>
        </div>
      `;
    }

    function createRoute() {
      alert('Создание маршрута — функция в разработке');
    }

    function optimizeAll() {
      alert('Оптимизация всех маршрутов — AI расчет экономии топлива и времени');
    }

    function fitAllRoutes() {
      const allCoords = routes.flatMap(r => r.waypoints.map(w => [w.lat, w.lng]));
      if (allCoords.length > 0) {
        const bounds = L.latLngBounds(allCoords);
        map.fitBounds(bounds, { padding: [30, 30] });
      }
    }

    function toggleTraffic() {
      alert('Слой пробок — интеграция с картами');
    }

    function logout() {
      if (typeof Routa !== 'undefined' && Routa.Auth) {
        Routa.Auth.logout();
      } else {
        localStorage.removeItem('routox_token');
        localStorage.removeItem('routox_role');
        window.location.href = 'login.html';
      }
    }

    // Update user info from localStorage
    const role = localStorage.getItem('routox_role') || 'logist';
    const roleData = {
      logist: { name: 'Логист', badge: 'Pro', color: 'text-amber-600' },
      owner: { name: 'Владелец', badge: 'Enterprise', color: 'text-purple-600' },
      admin: { name: 'Администратор', badge: 'Admin', color: 'text-red-600' },
      dispatcher: { name: 'Диспетчер', badge: 'Pro', color: 'text-blue-600' }
    };
    const data = roleData[role] || roleData.logist;
    const userNameEl = document.getElementById('userName');
    const userRoleEl = document.getElementById('userRole');
    if (userNameEl) userNameEl.textContent = data.name;
    if (userRoleEl) {
      userRoleEl.textContent = data.badge;
      userRoleEl.className = 'text-[9px] ' + data.color + ' font-semibold mt-0.5';
    }
  </script>
  <script src="./assets/js/smooth-navigation.js"></script>
</body>
</html>
