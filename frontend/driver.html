<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>RoutoX — Панель водителя</title>
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <script src="https://kit.fontawesome.com/a2e0e9e5a9.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <link rel="stylesheet" href="./assets/css/routox-unified.css">
  <style>
    /* Mobile-optimized driver panel */
    body {
      -webkit-tap-highlight-color: transparent;
    }

    /* Compact Tab Bar - Narrower */
    .driver-tabs {
      display: flex;
      gap: 4px;
      padding: 4px;
      background: var(--bg-secondary);
      border: 1px solid var(--border-color);
      border-radius: 14px;
      max-width: 280px;
      margin: 0 auto;
    }

    .driver-tab {
      flex: 1;
      padding: 8px 4px;
      border-radius: 10px;
      font-size: 11px;
      font-weight: 500;
      color: var(--text-secondary);
      transition: all 0.2s ease;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      background: transparent;
      border: none;
      cursor: pointer;
    }

    .driver-tab i {
      font-size: 14px;
    }

    .driver-tab:hover {
      color: var(--brand-blue);
    }

    .driver-tab.active {
      background: linear-gradient(135deg, #3b82f6, #10b981);
      color: white;
      box-shadow: 0 2px 10px rgba(59, 130, 246, 0.3);
    }

    .tab-content {
      display: none;
      animation: fadeIn 0.3s ease;
    }

    .tab-content.active {
      display: block;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(8px); }
      to { opacity: 1; transform: translateY(0); }
    }

    /* SOS Button */
    .btn-sos {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: white;
      animation: sosPulse 2s ease-in-out infinite;
    }

    @keyframes sosPulse {
      0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); }
      50% { box-shadow: 0 0 0 12px rgba(239, 68, 68, 0); }
    }

    /* Map */
    #driverMap {
      border-radius: 16px;
      z-index: 1;
    }

    .leaflet-control-zoom {
      border: none !important;
      border-radius: 10px !important;
      overflow: hidden;
    }

    .leaflet-control-zoom a {
      background: var(--bg-secondary) !important;
      color: var(--text-primary) !important;
      border: 1px solid var(--border-color) !important;
    }

    /* Timeline */
    .timeline-item {
      position: relative;
      padding-left: 24px;
    }

    .timeline-item::before {
      content: '';
      position: absolute;
      left: 5px;
      top: 24px;
      bottom: -12px;
      width: 2px;
      background: var(--border-color);
    }

    .timeline-item:last-child::before {
      display: none;
    }

    .timeline-dot {
      position: absolute;
      left: 0;
      top: 4px;
      width: 12px;
      height: 12px;
      border-radius: 50%;
      border: 2px solid currentColor;
      background: var(--bg-secondary);
    }

    /* Rest Warning */
    .rest-warning {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.1), rgba(245, 158, 11, 0.05));
      border: 1px solid rgba(245, 158, 11, 0.3);
    }

    [data-theme="dark"] .rest-warning {
      background: linear-gradient(135deg, rgba(245, 158, 11, 0.2), rgba(245, 158, 11, 0.1));
    }

    /* Fuel Gauge */
    .fuel-gauge {
      position: relative;
      width: 100px;
      height: 100px;
    }

    .fuel-gauge svg {
      transform: rotate(-90deg);
    }

    .fuel-gauge-bg {
      fill: none;
      stroke: var(--border-color);
      stroke-width: 8;
    }

    .fuel-gauge-fill {
      fill: none;
      stroke-width: 8;
      stroke-linecap: round;
      transition: stroke-dashoffset 0.5s ease;
    }

    /* Driver Photo */
    .driver-photo {
      width: 72px;
      height: 72px;
      border-radius: 16px;
      object-fit: cover;
      border: 3px solid var(--border-color);
    }

    /* Quick Action Buttons */
    .quick-action-btn {
      padding: 12px 8px;
      border-radius: 14px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 6px;
      transition: all 0.2s ease;
      background: var(--bg-card);
      border: 1px solid var(--border-color);
    }

    .quick-action-btn:active {
      transform: scale(0.95);
    }

    .quick-action-btn:hover {
      border-color: var(--border-hover);
      transform: translateY(-2px);
    }

    /* Live pulse */
    .live-pulse {
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.5; }
    }

    /* 3D Truck Icon */
    .truck-icon-3d {
      position: relative;
      transform-style: preserve-3d;
      animation: truckFloat 4s ease-in-out infinite;
    }

    @keyframes truckFloat {
      0%, 100% { transform: translateY(0) rotateY(0); }
      50% { transform: translateY(-5px) rotateY(5deg); }
    }
  </style>
</head>
<body class="min-h-screen pb-24">
  <!-- Header -->
  <header class="glass-panel mx-3 mt-3 px-4 py-3 flex items-center justify-between sticky top-3 z-30">
    <div class="flex items-center gap-3">
      <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-blue-500 to-emerald-500 flex items-center justify-center font-bold text-white text-sm shadow-lg">R</div>
      <div>
        <div class="font-semibold text-sm">RoutoX Driver</div>
        <div class="text-xs text-muted">Панель водителя</div>
      </div>
    </div>
    <div class="flex items-center gap-2">
      <div class="flex items-center gap-1.5 px-2.5 py-1 rounded-lg bg-emerald-500/15 border border-emerald-500/30">
        <span class="w-1.5 h-1.5 rounded-full bg-emerald-500 live-pulse"></span>
        <span class="text-xs text-emerald-600 font-medium">Online</span>
      </div>
      <div class="theme-toggle-track" onclick="toggleTheme()">
        <div class="theme-toggle-thumb"></div>
      </div>
      <button class="icon-btn" style="width: 36px; height: 36px;" onclick="showNotifications()">
        <i class="fa-solid fa-bell text-muted text-sm"></i>
        <span class="badge-dot" style="width: 16px; height: 16px; font-size: 10px;">2</span>
      </button>
    </div>
  </header>

  <!-- Main Content -->
  <main class="p-3 space-y-3">
    <!-- Current Trip Card -->
    <div class="glass-panel p-4">
      <div class="flex items-center justify-between mb-4">
        <div class="flex items-center gap-3">
          <div class="w-11 h-11 rounded-xl bg-gradient-to-br from-blue-500/20 to-emerald-500/20 border border-blue-500/30 flex items-center justify-center truck-icon-3d">
            <i class="fa-solid fa-route text-blue-500 text-lg"></i>
          </div>
          <div>
            <div class="text-xs text-muted">Текущий рейс</div>
            <div class="font-bold">Москва → СПб</div>
          </div>
        </div>
        <div class="text-right">
          <div class="text-xs text-muted">Прибытие</div>
          <div class="text-emerald-500 font-semibold">~14:30</div>
        </div>
      </div>

      <!-- Progress -->
      <div class="mb-4">
        <div class="flex justify-between text-sm mb-2">
          <span class="text-muted">Прогресс</span>
          <span class="font-semibold">456 км / 680 км</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill progress-fill-gradient" style="width: 67%"></div>
        </div>
      </div>

      <!-- Stats Grid -->
      <div class="grid grid-cols-3 gap-2">
        <div class="glass-card p-3 text-center">
          <div class="text-xl font-bold text-blue-500">224</div>
          <div class="text-xs text-muted">км осталось</div>
        </div>
        <div class="glass-card p-3 text-center">
          <div class="text-xl font-bold text-emerald-500">4ч 15м</div>
          <div class="text-xs text-muted">в пути</div>
        </div>
        <div class="glass-card p-3 text-center">
          <div class="text-xl font-bold text-amber-500">72%</div>
          <div class="text-xs text-muted">топливо</div>
        </div>
      </div>
    </div>

    <!-- Rest Time Warning (ФЗ-196) -->
    <div class="rest-warning glass-panel p-3 flex items-center gap-3">
      <div class="w-10 h-10 rounded-xl bg-amber-500/20 flex items-center justify-center flex-shrink-0">
        <i class="fa-solid fa-clock text-amber-500 text-lg"></i>
      </div>
      <div class="flex-1">
        <div class="font-semibold text-amber-600 text-sm">Режим труда и отдыха</div>
        <div class="text-sm">До перерыва: <span class="font-bold">1ч 45м</span></div>
        <div class="text-xs text-muted mt-0.5">ФЗ-196: макс. 4.5ч вождения</div>
      </div>
    </div>

    <!-- Tab Content -->
    <div class="tab-content active" id="tabTrip">
      <!-- Map Section -->
      <div class="glass-panel p-4 mb-3">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-semibold text-sm">Маршрут</h3>
          <button class="text-xs text-blue-500 font-medium">Навигация →</button>
        </div>
        <div id="driverMap" class="h-44 rounded-xl"></div>
      </div>

      <!-- Route Timeline -->
      <div class="glass-panel p-4">
        <h3 class="font-semibold mb-4 text-sm">Точки маршрута</h3>
        <div class="space-y-4">
          <div class="timeline-item">
            <div class="timeline-dot bg-emerald-500 border-emerald-500"></div>
            <div class="text-sm font-medium">Москва, Склад-1</div>
            <div class="text-xs text-emerald-500">Выезд 06:00 ✓</div>
          </div>
          <div class="timeline-item">
            <div class="timeline-dot bg-blue-500 border-blue-500"></div>
            <div class="text-sm font-medium">Тверь (транзит)</div>
            <div class="text-xs text-blue-500">Сейчас здесь • 10:15</div>
          </div>
          <div class="timeline-item">
            <div class="timeline-dot border-gray-400"></div>
            <div class="text-sm font-medium text-muted">В. Волочёк</div>
            <div class="text-xs text-muted">~11:30</div>
          </div>
          <div class="timeline-item">
            <div class="timeline-dot border-gray-400"></div>
            <div class="text-sm font-medium text-muted">СПб, Клиент "Нева"</div>
            <div class="text-xs text-muted">ETA: 14:30</div>
          </div>
        </div>
      </div>
    </div>

    <div class="tab-content" id="tabDocs">
      <div class="glass-panel p-4 mb-3">
        <h3 class="font-semibold mb-3 text-sm">Документы рейса</h3>
        <div class="space-y-2">
          <div class="glass-card p-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="w-9 h-9 rounded-xl bg-cyan-500/15 flex items-center justify-center">
                <i class="fa-solid fa-file-lines text-cyan-500"></i>
              </div>
              <div>
                <div class="font-medium text-sm">eTTН #45892</div>
                <div class="text-xs text-muted">Электронная накладная</div>
              </div>
            </div>
            <span class="badge badge-success">Подписан</span>
          </div>
          <div class="glass-card p-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="w-9 h-9 rounded-xl bg-amber-500/15 flex items-center justify-center">
                <i class="fa-solid fa-file-invoice text-amber-500"></i>
              </div>
              <div>
                <div class="font-medium text-sm">Путевой лист</div>
                <div class="text-xs text-muted">№ PL-2024-1234</div>
              </div>
            </div>
            <span class="badge badge-success">Активен</span>
          </div>
          <div class="glass-card p-3 flex items-center justify-between">
            <div class="flex items-center gap-3">
              <div class="w-9 h-9 rounded-xl bg-purple-500/15 flex items-center justify-center">
                <i class="fa-solid fa-qrcode text-purple-500"></i>
              </div>
              <div>
                <div class="font-medium text-sm">QR для клиента</div>
                <div class="text-xs text-muted">Подтверждение доставки</div>
              </div>
            </div>
            <button class="badge badge-info cursor-pointer">Показать</button>
          </div>
        </div>
      </div>

      <div class="glass-panel p-4">
        <h3 class="font-semibold mb-3 text-sm">Груз</h3>
        <div class="grid grid-cols-2 gap-2">
          <div class="glass-card p-3">
            <div class="text-xs text-muted">Вес</div>
            <div class="text-lg font-bold">18.5 т</div>
          </div>
          <div class="glass-card p-3">
            <div class="text-xs text-muted">Палеты</div>
            <div class="text-lg font-bold">24 шт</div>
          </div>
          <div class="glass-card p-3">
            <div class="text-xs text-muted">Тип</div>
            <div class="text-lg font-bold">Продукты</div>
          </div>
          <div class="glass-card p-3">
            <div class="text-xs text-muted">Температура</div>
            <div class="text-lg font-bold text-cyan-500">+4°C</div>
          </div>
        </div>
      </div>
    </div>

    <div class="tab-content" id="tabVehicle">
      <div class="glass-panel p-4 mb-3">
        <div class="flex items-center gap-4 mb-4">
          <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-blue-500/20 to-emerald-500/20 border border-blue-500/30 flex items-center justify-center truck-icon-3d">
            <i class="fa-solid fa-truck text-blue-500 text-xl"></i>
          </div>
          <div>
            <div class="text-lg font-bold">Е123МВ 777</div>
            <div class="text-sm text-muted">Volvo FH 2021 • Рефрижератор</div>
          </div>
        </div>

        <!-- Fuel Gauge -->
        <div class="flex items-center justify-center mb-4">
          <div class="fuel-gauge">
            <svg viewBox="0 0 100 100" width="100" height="100">
              <circle class="fuel-gauge-bg" cx="50" cy="50" r="42"/>
              <circle class="fuel-gauge-fill" cx="50" cy="50" r="42" stroke="url(#fuelGrad)" stroke-dasharray="264" stroke-dashoffset="74"/>
              <defs>
                <linearGradient id="fuelGrad" x1="0%" y1="0%" x2="100%" y2="0%">
                  <stop offset="0%" stop-color="#3b82f6"/>
                  <stop offset="100%" stop-color="#10b981"/>
                </linearGradient>
              </defs>
            </svg>
            <div class="absolute inset-0 flex flex-col items-center justify-center">
              <i class="fa-solid fa-gas-pump text-blue-500 text-sm mb-1"></i>
              <span class="text-xl font-bold">72%</span>
              <span class="text-xs text-muted">~520 км</span>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-2">
          <div class="glass-card p-3">
            <div class="text-xs text-muted">Пробег</div>
            <div class="text-base font-bold">234,567 км</div>
          </div>
          <div class="glass-card p-3">
            <div class="text-xs text-muted">ТО через</div>
            <div class="text-base font-bold text-amber-500">12,433 км</div>
          </div>
          <div class="glass-card p-3">
            <div class="text-xs text-muted">Давление шин</div>
            <div class="text-base font-bold text-emerald-500">OK</div>
          </div>
          <div class="glass-card p-3">
            <div class="text-xs text-muted">Темп. рефр.</div>
            <div class="text-base font-bold text-cyan-500">+4°C</div>
          </div>
        </div>
      </div>

      <!-- Quick Actions -->
      <div class="glass-panel p-4">
        <h3 class="font-semibold mb-3 text-sm">Быстрые действия</h3>
        <div class="grid grid-cols-4 gap-2">
          <button class="quick-action-btn" onclick="reportFuel()">
            <i class="fa-solid fa-gas-pump text-amber-500 text-lg"></i>
            <span class="text-xs">Заправка</span>
          </button>
          <button class="quick-action-btn" onclick="reportIssue()">
            <i class="fa-solid fa-triangle-exclamation text-red-500 text-lg"></i>
            <span class="text-xs">Проблема</span>
          </button>
          <button class="quick-action-btn" onclick="startRest()">
            <i class="fa-solid fa-bed text-purple-500 text-lg"></i>
            <span class="text-xs">Отдых</span>
          </button>
          <button class="quick-action-btn" onclick="callDispatcher()">
            <i class="fa-solid fa-headset text-blue-500 text-lg"></i>
            <span class="text-xs">Диспетчер</span>
          </button>
        </div>
      </div>
    </div>

    <div class="tab-content" id="tabProfile">
      <div class="glass-panel p-4 mb-3">
        <div class="flex items-center gap-4 mb-4">
          <img src="https://randomuser.me/api/portraits/men/32.jpg" alt="Driver" class="driver-photo" id="driverPhoto">
          <div>
            <div class="text-lg font-bold">Иванов Алексей</div>
            <div class="text-sm text-muted">Водитель категории CE</div>
            <div class="flex items-center gap-2 mt-1">
              <span class="badge badge-success">Активен</span>
              <span class="text-xs text-muted">ID: DRV-1234</span>
            </div>
          </div>
        </div>
        
        <div class="space-y-2">
          <div class="flex items-center justify-between p-3 glass-card">
            <div class="flex items-center gap-3">
              <i class="fa-solid fa-phone text-emerald-500"></i>
              <span class="text-sm">+7 (999) 123-45-67</span>
            </div>
            <i class="fa-solid fa-chevron-right text-muted text-xs"></i>
          </div>
          <div class="flex items-center justify-between p-3 glass-card">
            <div class="flex items-center gap-3">
              <i class="fa-solid fa-id-card text-blue-500"></i>
              <span class="text-sm">ВУ: 77 АА 123456</span>
            </div>
            <span class="text-xs text-muted">до 2028</span>
          </div>
          <div class="flex items-center justify-between p-3 glass-card">
            <div class="flex items-center gap-3">
              <i class="fa-solid fa-calendar text-purple-500"></i>
              <span class="text-sm">Стаж: 8 лет</span>
            </div>
          </div>
        </div>
      </div>

      <div class="glass-panel p-4 mb-3">
        <h3 class="font-semibold mb-3 text-sm">Статистика</h3>
        <div class="grid grid-cols-2 gap-2">
          <div class="glass-card p-3 text-center">
            <div class="text-xl font-bold text-emerald-500">156</div>
            <div class="text-xs text-muted">рейсов</div>
          </div>
          <div class="glass-card p-3 text-center">
            <div class="text-xl font-bold text-blue-500">89,234</div>
            <div class="text-xs text-muted">км пройдено</div>
          </div>
          <div class="glass-card p-3 text-center">
            <div class="text-xl font-bold text-amber-500">4.9</div>
            <div class="text-xs text-muted">рейтинг</div>
          </div>
          <div class="glass-card p-3 text-center">
            <div class="text-xl font-bold text-purple-500">0</div>
            <div class="text-xs text-muted">нарушений</div>
          </div>
        </div>
      </div>

      <button class="w-full glass-card p-3 flex items-center justify-between text-red-500" onclick="logout()">
        <div class="flex items-center gap-3">
          <i class="fa-solid fa-right-from-bracket"></i>
          <span class="text-sm font-medium">Выйти из аккаунта</span>
        </div>
        <i class="fa-solid fa-chevron-right text-xs"></i>
      </button>
    </div>

    <!-- SOS Button -->
    <div class="fixed bottom-24 right-3 z-20">
      <button class="btn-sos w-14 h-14 rounded-full flex items-center justify-center shadow-lg" onclick="triggerSOS()">
        <span class="text-base font-bold">SOS</span>
      </button>
    </div>
  </main>

  <!-- Compact Bottom Tab Bar (Narrower) -->
  <nav class="fixed bottom-0 left-0 right-0 px-3 pb-2 pt-1 z-30">
    <div class="driver-tabs">
      <button class="driver-tab active" data-tab="tabTrip">
        <i class="fa-solid fa-route"></i>
        <span>Рейс</span>
      </button>
      <button class="driver-tab" data-tab="tabDocs">
        <i class="fa-solid fa-file-lines"></i>
        <span>Доки</span>
      </button>
      <button class="driver-tab" data-tab="tabVehicle">
        <i class="fa-solid fa-truck"></i>
        <span>ТС</span>
      </button>
      <button class="driver-tab" data-tab="tabProfile">
        <i class="fa-solid fa-user"></i>
        <span>Я</span>
      </button>
    </div>
  </nav>

  <!-- SOS Modal -->
  <div id="sosModal" class="modal-backdrop">
    <div class="modal-content glass-panel p-6 text-center max-w-sm mx-auto">
      <div class="w-16 h-16 mx-auto mb-4 rounded-full bg-red-500/20 flex items-center justify-center">
        <i class="fa-solid fa-phone-volume text-red-500 text-2xl"></i>
      </div>
      <h2 class="text-lg font-bold mb-2">Экстренный вызов</h2>
      <p class="text-muted text-sm mb-6">Сигнал SOS будет отправлен диспетчеру и экстренным службам</p>
      <div class="space-y-2">
        <button class="w-full btn-sos py-3 rounded-xl font-bold" onclick="confirmSOS()">Подтвердить SOS</button>
        <button class="w-full glass-card p-3 text-sm font-medium" onclick="closeSOS()">Отмена</button>
      </div>
    </div>
  </div>

  <script>
    // Theme toggle
    const savedTheme = localStorage.getItem('routoxTheme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);

    function toggleTheme() {
      const current = document.documentElement.getAttribute('data-theme');
      const next = current === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('routoxTheme', next);
      
      // Update map tiles
      if (tileLayer) {
        if (next === 'dark') {
          tileLayer.setUrl('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png');
        } else {
          tileLayer.setUrl('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png');
        }
      }
    }

    // Random driver photos
    const driverPhotos = [
      'https://randomuser.me/api/portraits/men/32.jpg',
      'https://randomuser.me/api/portraits/men/45.jpg',
      'https://randomuser.me/api/portraits/men/67.jpg',
      'https://randomuser.me/api/portraits/men/22.jpg',
      'https://randomuser.me/api/portraits/men/55.jpg',
      'https://randomuser.me/api/portraits/men/78.jpg'
    ];
    
    const photoEl = document.getElementById('driverPhoto');
    if (photoEl) {
      photoEl.src = driverPhotos[Math.floor(Math.random() * driverPhotos.length)];
    }

    // Initialize map
    let map, tileLayer;
    
    function initMap() {
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      map = L.map('driverMap', { zoomControl: false }).setView([56.8584, 35.9176], 10);
      tileLayer = L.tileLayer(
        isDark 
          ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
          : 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
        { attribution: '© OSM' }
      ).addTo(map);
      
      // Route line
      const routeCoords = [[55.7558, 37.6173], [56.8584, 35.9176], [59.9343, 30.3351]];
      L.polyline(routeCoords, { color: '#3b82f6', weight: 4, opacity: 0.8 }).addTo(map);
      
      // Current position marker
      L.marker([56.8584, 35.9176], {
        icon: L.divIcon({
          className: 'custom-marker',
          html: '<div style="width:20px;height:20px;background:#10b981;border-radius:50%;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.3);"></div>',
          iconSize: [20, 20],
          iconAnchor: [10, 10]
        })
      }).addTo(map);
    }

    // Tab switching
    document.querySelectorAll('.driver-tab').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.driver-tab').forEach(b => b.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        btn.classList.add('active');
        document.getElementById(btn.dataset.tab).classList.add('active');
        
        // Refresh map when trip tab is shown
        if (btn.dataset.tab === 'tabTrip') {
          setTimeout(() => {
            if (map) map.invalidateSize();
          }, 100);
        }
      });
    });

    // SOS functions
    function triggerSOS() {
      document.getElementById('sosModal').classList.add('active');
    }

    function closeSOS() {
      document.getElementById('sosModal').classList.remove('active');
    }

    function confirmSOS() {
      alert('SOS сигнал отправлен! Диспетчер свяжется с вами.');
      closeSOS();
    }

    // Quick actions
    function reportFuel() { alert('Форма заправки откроется'); }
    function reportIssue() { alert('Форма отчёта о проблеме откроется'); }
    function startRest() { alert('Начало периода отдыха зафиксировано'); }
    function callDispatcher() { window.location.href = 'tel:+78001234567'; }
    function logout() { if(confirm('Выйти из аккаунта?')) window.location.href = './login.html'; }
    function showNotifications() { alert('Уведомления: 2 новых сообщения'); }

    // Initialize map after DOM load
    document.addEventListener('DOMContentLoaded', initMap);
  </script>
</body>
</html>
