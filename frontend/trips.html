<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RoutoX — Рейсы</title>
  <link rel="stylesheet" href="./assets/css/routox-unified.css">
  <link rel="stylesheet" href="./assets/css/page-transitions.css">
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <script src="https://kit.fontawesome.com/a2e0e9e5a9.js" crossorigin="anonymous"></script>
  <link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:wght,FILL@100..700,0..1&display=swap" rel="stylesheet"/>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    #tripMap { border-radius: 16px; z-index: 1; }
    .leaflet-control-zoom { border: none !important; border-radius: 10px !important; overflow: hidden; }
    .leaflet-control-zoom a { background: var(--bg-secondary) !important; color: var(--text-primary) !important; border: 1px solid var(--border-color) !important; }
    .status-badge { padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
    .status-active { background: rgba(16, 185, 129, 0.15); color: #10b981; }
    .status-planned { background: rgba(59, 130, 246, 0.15); color: #3b82f6; }
    .status-completed { background: rgba(107, 114, 128, 0.15); color: #6b7280; }
    .status-delayed { background: rgba(245, 158, 11, 0.15); color: #f59e0b; }
    .trip-card { cursor: pointer; position: relative; overflow: hidden; }
    .trip-card::before { content: ''; position: absolute; left: 0; top: 0; bottom: 0; width: 4px; border-radius: 4px 0 0 4px; }
    .trip-card.active::before { background: linear-gradient(180deg, #10b981, #3b82f6); }
    .trip-card.planned::before { background: #3b82f6; }
    .trip-card.completed::before { background: #6b7280; }
    .trip-card.delayed::before { background: #f59e0b; }
    .trip-card.selected { border-color: rgba(59, 130, 246, 0.5); background: rgba(59, 130, 246, 0.05); }
    .progress-ring { transform: rotate(-90deg); }
    .progress-ring circle { transition: stroke-dashoffset 0.5s ease; }
    .route-point { width: 12px; height: 12px; border-radius: 50%; border: 2px solid currentColor; }
    .route-line { width: 2px; height: 24px; background: currentColor; opacity: 0.3; }
    .live-pulse { animation: pulse 2s ease-in-out infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.5; } }
    .tab-btn { padding: 8px 16px; border-radius: 10px; font-size: 13px; color: var(--text-secondary); transition: all 0.2s ease; font-weight: 500; }
    .tab-btn:hover { color: #3b82f6; background: rgba(59, 130, 246, 0.08); }
    .tab-btn.active { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; }
    .stat-value { font-size: 28px; font-weight: 700; background: linear-gradient(135deg, #3b82f6, #10b981); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
    .role-badge { display: inline-flex; align-items: center; gap: 6px; padding: 4px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; }
    .role-badge.admin { background: rgba(59, 130, 246, 0.15); color: #3b82f6; border: 1px solid rgba(59, 130, 246, 0.3); }
    .role-badge.owner { background: rgba(139, 92, 246, 0.15); color: #8b5cf6; border: 1px solid rgba(139, 92, 246, 0.3); }
    .role-badge.dispatcher { background: rgba(16, 185, 129, 0.15); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.3); }
    .btn-secondary { padding: 8px 16px; background: var(--bg-secondary); border: 1px solid var(--border-color); border-radius: 10px; font-size: 13px; font-weight: 500; transition: all 0.2s; }
    .btn-secondary:hover { background: var(--bg-card); border-color: rgba(59, 130, 246, 0.3); }
  </style>
</head>
<body class="min-h-screen">
  <!-- Header -->
  <header class="h-16 glass-panel flex items-center justify-between px-6 z-40 shrink-0 border-b border-white/50 sticky top-0 mx-4 mt-4 rounded-2xl">
    <div class="flex items-center gap-12">
        <div class="flex items-center gap-3">
            <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-amber-500 to-orange-600 flex items-center justify-center text-white font-extrabold text-xl shadow-lg shadow-amber-500/20">
                R
            </div>
            <div class="flex flex-col">
                <span class="font-bold text-lg leading-none tracking-tight text-slate-800">RoutoX</span>
                <span class="text-[10px] text-slate-400 font-semibold uppercase tracking-widest mt-0.5">Logist Panel</span>
            </div>
        </div>
        <nav class="hidden lg:flex items-center gap-1 bg-slate-100/50 p-1 rounded-xl">
            <a class="px-3 py-1.5 rounded-lg text-sm font-medium text-slate-500 hover:text-slate-800 hover:bg-white/60 transition-colors" href="logist.html">Заказы</a>
            <a class="px-3 py-1.5 rounded-lg text-sm font-medium text-slate-500 hover:text-slate-800 hover:bg-white/60 transition-colors" href="routes.html">Маршруты</a>
            <a class="px-3 py-1.5 rounded-lg text-sm font-semibold nav-item-active transition-all" href="trips.html">Рейсы</a>
            <a class="px-3 py-1.5 rounded-lg text-sm font-medium text-slate-500 hover:text-slate-800 hover:bg-white/60 transition-colors" href="drivers-manage.html">Водители</a>
            <a class="px-3 py-1.5 rounded-lg text-sm font-medium text-slate-500 hover:text-slate-800 hover:bg-white/60 transition-colors" href="clients.html">Клиенты</a>
            <a class="px-3 py-1.5 rounded-lg text-sm font-medium text-slate-500 hover:text-slate-800 hover:bg-white/60 transition-colors" href="warehouse.html">Склад</a>
            <a class="px-3 py-1.5 rounded-lg text-sm font-medium text-slate-500 hover:text-slate-800 hover:bg-white/60 transition-colors" href="loading-plan.html">Планирование</a>
            <a class="px-3 py-1.5 rounded-lg text-sm font-medium text-slate-500 hover:text-slate-800 hover:bg-white/60 transition-colors" href="delivery-stats.html">Статистика</a>
            <a class="px-3 py-1.5 rounded-lg text-sm font-medium text-slate-500 hover:text-slate-800 hover:bg-white/60 transition-colors" href="geozones.html">Геозоны</a>
        </nav>
    </div>
    <div class="flex items-center gap-5">
        <div class="px-3 py-1.5 bg-white/60 backdrop-blur-md border border-white/60 rounded-full flex items-center gap-2 shadow-sm">
            <span class="relative flex h-2.5 w-2.5">
                <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-emerald-400 opacity-75"></span>
                <span class="relative inline-flex rounded-full h-2.5 w-2.5 bg-emerald-500"></span>
            </span>
            <span class="text-xs font-bold text-slate-700 tracking-tight">LIVE</span>
        </div>
        <div class="h-6 w-px bg-slate-200"></div>
        <span class="role-badge logist px-3 py-1.5 rounded-full text-xs font-semibold" style="background: rgba(245, 158, 11, 0.15); color: #f59e0b; border: 1px solid rgba(245, 158, 11, 0.3);">
            <i class="fa-solid fa-route"></i>
            <span>Логист</span>
        </span>
        <div class="flex items-center gap-3 pl-1 pr-1 py-1 bg-white/50 border border-white rounded-full shadow-sm hover:shadow-md transition-shadow cursor-pointer">
            <div class="w-8 h-8 rounded-full bg-slate-200 overflow-hidden ring-2 ring-white">
                <img alt="User" class="w-full h-full object-cover" src="https://lh3.googleusercontent.com/aida-public/AB6AXuCTs9iN8pKS03W5I54u9FB4B-c8kh0-SvddoYiVdknvnn0XFQ_ScxzcOGMuvCw75ZDO7eej3OBFSUyW7YGzfIdw8bm2JVE2qYntX-6WFsuWZDXeCjqgvXyR-Lo9UnAE2bTQejiaicaZNqXTEEWzBEmoalZytqScbtdaXlk0i5laN5yjsqI3j457keHzESRrW4bLeWD2l5xuer1uZ4Zd_LMeP8p-XTEa4_wtLTcRyHGOncDuMQUJk788z8tvDII7r8UTdnahdzzaAtY"/>
            </div>
            <div class="pr-3 flex flex-col items-end leading-none">
                <p class="text-xs font-bold text-slate-800" id="userName">Логист</p>
                <p class="text-[9px] text-amber-600 font-semibold mt-0.5" id="userRole">Pro</p>
            </div>
        </div>
        <button class="w-10 h-10 flex items-center justify-center text-slate-400 hover:text-slate-700 bg-white/50 hover:bg-white rounded-full transition-all shadow-sm border border-white/50 relative" title="Уведомления" onclick="window.location.href='notifications.html'">
            <span class="material-symbols-outlined text-[20px]">notifications</span>
            <span class="absolute top-2.5 right-2.5 w-2 h-2 bg-red-500 rounded-full ring-2 ring-white"></span>
        </button>
        <button class="w-10 h-10 flex items-center justify-center text-slate-400 hover:text-red-500 bg-white/50 hover:bg-white rounded-full transition-all shadow-sm border border-white/50" title="Выход" onclick="logout()">
            <span class="material-symbols-outlined text-[20px]">logout</span>
        </button>
    </div>
  </header>

  <!-- Main Content -->
  <main class="p-4 grid grid-cols-12 gap-4" style="height: calc(100vh - 100px);">
    <!-- Left Panel - Trip List -->
    <aside class="col-span-4 space-y-4 overflow-hidden flex flex-col">
      <!-- Stats Row -->
      <div class="glass-panel p-4">
        <div class="grid grid-cols-4 gap-2">
          <div class="stat-card glass-card"><div class="stat-value">12</div><div class="text-xs text-muted mt-1">В пути</div></div>
          <div class="stat-card glass-card"><div class="stat-value">5</div><div class="text-xs text-muted mt-1">Плановые</div></div>
          <div class="stat-card glass-card"><div class="stat-value">2</div><div class="text-xs text-muted mt-1">Опоздания</div></div>
          <div class="stat-card glass-card"><div class="stat-value">47</div><div class="text-xs text-muted mt-1">За неделю</div></div>
        </div>
      </div>

      <!-- Filters & Actions -->
      <div class="glass-panel p-4">
        <div class="flex items-center gap-3 mb-3">
          <div class="relative flex-1">
            <input type="text" placeholder="Поиск рейсов..." class="input-field w-full rounded-xl px-4 py-2.5 pl-10 text-sm">
            <i class="fa-solid fa-magnifying-glass absolute left-3 top-1/2 -translate-y-1/2 text-muted text-sm"></i>
          </div>
          <button class="btn-primary flex items-center gap-2 whitespace-nowrap" onclick="showNewTripModal()"><i class="fa-solid fa-plus"></i>Новый рейс</button>
          <button class="btn btn-secondary flex items-center gap-2 whitespace-nowrap" onclick="showProfitCalculator()"><i class="fa-solid fa-calculator"></i>Экономика</button>
        </div>
        <div class="flex gap-2">
          <button class="tab-btn active" data-filter="all">Все</button>
          <button class="tab-btn" data-filter="active">В пути</button>
          <button class="tab-btn" data-filter="planned">Плановые</button>
          <button class="tab-btn" data-filter="completed">Завершённые</button>
        </div>
      </div>

      <!-- Trip List -->
      <div class="glass-panel p-4 flex-1 overflow-hidden flex flex-col">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-semibold">Рейсы</h3>
          <span class="text-xs px-2 py-1 rounded-lg bg-slate-100 dark:bg-slate-800 text-muted" id="tripCount">12 рейсов</span>
        </div>
        <div class="space-y-3 overflow-y-auto custom-scroll flex-1" id="tripList">
          <!-- Rendered by JS -->
        </div>
      </div>
    </aside>

    <!-- Center Panel - Map -->
    <section class="col-span-5 glass-panel p-4 relative overflow-hidden">
      <div id="tripMap" class="absolute inset-4 rounded-2xl"></div>
      <!-- Map Controls -->
      <div class="absolute top-8 right-8 z-10 flex gap-2">
        <button class="icon-btn" title="Показать все рейсы"><i class="fa-solid fa-expand text-muted"></i></button>
        <button class="icon-btn" title="Трафик"><i class="fa-solid fa-car text-muted"></i></button>
        <button class="icon-btn" title="Погода"><i class="fa-solid fa-cloud text-muted"></i></button>
      </div>
      <!-- Route Info Overlay -->
      <div class="absolute bottom-8 left-8 right-8 z-10">
        <div class="glass-card p-4">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-4">
              <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500/20 to-emerald-500/20 border border-blue-500/30 flex items-center justify-center">
                <i class="fa-solid fa-truck text-blue-500 text-xl"></i>
              </div>
              <div>
                <div class="font-semibold" id="selectedTripName">TR-001 • Москва → СПб</div>
                <div class="text-sm text-muted" id="selectedTripDriver">Водитель: Иванов А.П.</div>
              </div>
            </div>
            <div class="flex items-center gap-6">
              <div class="text-center">
                <div class="text-lg font-bold text-emerald-500" id="selectedTripDistance">456 км</div>
                <div class="text-xs text-muted">Осталось</div>
              </div>
              <div class="text-center">
                <div class="text-lg font-bold text-blue-500" id="selectedTripETA">~5ч 30м</div>
                <div class="text-xs text-muted">ETA</div>
              </div>
              <div class="text-center">
                <div class="text-lg font-bold text-amber-500" id="selectedTripProgress">67%</div>
                <div class="text-xs text-muted">Прогресс</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Right Panel - Trip Details -->
    <aside class="col-span-3 space-y-4 overflow-hidden flex flex-col">
      <div class="glass-panel p-5 flex-1 overflow-y-auto custom-scroll" id="tripDetails">
        <div class="flex items-center justify-between mb-4">
          <span class="text-xs text-muted uppercase tracking-wider">Детали рейса</span>
          <span class="status-badge status-active" id="tripStatusBadge">В пути</span>
        </div>

        <!-- Progress Ring -->
        <div class="flex justify-center mb-4">
          <div class="relative">
            <svg class="progress-ring w-24 h-24">
              <circle cx="48" cy="48" r="40" fill="none" stroke="currentColor" stroke-width="8" class="text-slate-200 dark:text-slate-700"/>
              <circle cx="48" cy="48" r="40" fill="none" stroke="url(#progressGradient)" stroke-width="8" stroke-linecap="round" stroke-dasharray="251" stroke-dashoffset="83" id="progressCircle"/>
              <defs><linearGradient id="progressGradient" x1="0%" y1="0%" x2="100%" y2="0%"><stop offset="0%" stop-color="#3b82f6"/><stop offset="100%" stop-color="#10b981"/></linearGradient></defs>
            </svg>
            <div class="absolute inset-0 flex items-center justify-center">
              <span class="text-2xl font-bold" id="tripProgressValue">67%</span>
            </div>
          </div>
        </div>

        <h3 class="text-lg font-bold text-center mb-1" id="detailTripName">Рейс TR-001</h3>
        <p class="text-sm text-muted text-center mb-4" id="detailTripRoute">Москва → Санкт-Петербург</p>

        <!-- Route Timeline -->
        <div class="space-y-0 mb-4">
          <div class="flex items-center gap-3">
            <div class="flex flex-col items-center">
              <div class="route-point text-emerald-500 bg-emerald-500"></div>
              <div class="route-line bg-emerald-500"></div>
            </div>
            <div class="flex-1">
              <div class="text-sm font-medium">Москва, Склад-1</div>
              <div class="text-xs text-muted">Выезд: 06:00 ✓</div>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <div class="flex flex-col items-center">
              <div class="route-point text-blue-500"></div>
              <div class="route-line bg-blue-500"></div>
            </div>
            <div class="flex-1">
              <div class="text-sm font-medium">Тверь (транзит)</div>
              <div class="text-xs text-blue-500">Сейчас здесь</div>
            </div>
          </div>
          <div class="flex items-center gap-3">
            <div class="flex flex-col items-center">
              <div class="route-point text-slate-400"></div>
            </div>
            <div class="flex-1">
              <div class="text-sm font-medium text-muted">СПб, Клиент "Нева"</div>
              <div class="text-xs text-muted">ETA: 14:30</div>
            </div>
          </div>
        </div>

        <!-- Trip Info Grid -->
        <div class="grid grid-cols-2 gap-3 text-sm mb-4">
          <div class="glass-card p-3">
            <div class="text-xs text-muted mb-1">Водитель</div>
            <div class="font-medium flex items-center gap-2"><i class="fa-solid fa-user text-blue-500"></i>Иванов А.П.</div>
          </div>
          <div class="glass-card p-3">
            <div class="text-xs text-muted mb-1">ТС</div>
            <div class="font-medium flex items-center gap-2"><i class="fa-solid fa-truck text-emerald-500"></i>Е123МВ 777</div>
          </div>
          <div class="glass-card p-3">
            <div class="text-xs text-muted mb-1">Груз</div>
            <div class="font-medium flex items-center gap-2"><i class="fa-solid fa-box text-amber-500"></i>18.5 т</div>
          </div>
          <div class="glass-card p-3">
            <div class="text-xs text-muted mb-1">Топливо</div>
            <div class="font-medium flex items-center gap-2"><i class="fa-solid fa-gas-pump text-purple-500"></i>72%</div>
          </div>
        </div>

        <!-- Documents -->
        <div class="mb-4">
          <div class="text-xs text-muted uppercase tracking-wider mb-2">Документы</div>
          <div class="space-y-2">
            <div class="flex items-center justify-between p-2 glass-card">
              <div class="flex items-center gap-2"><i class="fa-solid fa-file-lines text-cyan-500"></i><span class="text-sm">eTTН #45892</span></div>
              <span class="text-xs text-emerald-500">✓ Подписан</span>
            </div>
            <div class="flex items-center justify-between p-2 glass-card">
              <div class="flex items-center gap-2"><i class="fa-solid fa-file-invoice text-amber-500"></i><span class="text-sm">Накладная</span></div>
              <span class="text-xs text-emerald-500">✓ Готов</span>
            </div>
          </div>
        </div>

        <!-- Actions -->
        <div class="flex gap-2">
          <button class="flex-1 btn-primary text-sm flex items-center justify-center gap-2"><i class="fa-solid fa-phone"></i>Связаться</button>
          <button class="icon-btn"><i class="fa-solid fa-ellipsis-vertical text-muted"></i></button>
        </div>
      </div>

      <!-- Recent Events -->
      <div class="glass-panel p-4">
        <div class="flex items-center justify-between mb-3">
          <h3 class="font-semibold text-sm">События рейса</h3>
          <span class="text-xs text-blue-500 cursor-pointer hover:underline">Все →</span>
        </div>
        <div class="space-y-2 text-sm">
          <div class="flex items-start gap-2">
            <i class="fa-solid fa-location-dot text-emerald-500 mt-1"></i>
            <div><div>Проехал Тверь</div><div class="text-xs text-muted">10:45</div></div>
          </div>
          <div class="flex items-start gap-2">
            <i class="fa-solid fa-gas-pump text-amber-500 mt-1"></i>
            <div><div>Заправка +120л</div><div class="text-xs text-muted">09:20</div></div>
          </div>
          <div class="flex items-start gap-2">
            <i class="fa-solid fa-play text-blue-500 mt-1"></i>
            <div><div>Рейс начат</div><div class="text-xs text-muted">06:00</div></div>
          </div>
        </div>
      </div>
    </aside>
  </main>

  <script>
    // Theme management
    const savedTheme = localStorage.getItem('routoxTheme') || 'light';
    document.documentElement.setAttribute('data-theme', savedTheme);

    function toggleTheme() {
      const current = document.documentElement.getAttribute('data-theme');
      const next = current === 'dark' ? 'light' : 'dark';
      document.documentElement.setAttribute('data-theme', next);
      localStorage.setItem('routoxTheme', next);
      updateMapTiles();
    }

    // Initialize map
    const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
    const map = L.map('tripMap', { zoomControl: false }).setView([56.8, 37.5], 7);
    L.control.zoom({ position: 'bottomright' }).addTo(map);
    
    let tileLayer = L.tileLayer(
      isDark 
        ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
        : 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png',
      { attribution: '© OpenStreetMap' }
    ).addTo(map);

    function updateMapTiles() {
      const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
      tileLayer.setUrl(
        isDark 
          ? 'https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png'
          : 'https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png'
      );
    }

    // Trip data
    const trips = [
      { id: 1, name: 'TR-001', from: 'Москва', to: 'Санкт-Петербург', driver: 'Иванов А.П.', vehicle: 'Е123МВ 777', status: 'active', progress: 67, lat: 56.8584, lng: 35.9176, distance: 456, eta: '5ч 30м', cargo: '18.5 т', fuel: 72 },
      { id: 2, name: 'TR-002', from: 'Москва', to: 'Казань', driver: 'Петров С.И.', vehicle: 'М456АК 777', status: 'active', progress: 45, lat: 55.5, lng: 41.5, distance: 520, eta: '7ч 15м', cargo: '22 т', fuel: 58 },
      { id: 3, name: 'TR-003', from: 'СПб', to: 'Москва', driver: 'Сидоров К.В.', vehicle: 'О789РТ 78', status: 'active', progress: 82, lat: 57.5, lng: 34.2, distance: 180, eta: '2ч 45м', cargo: '15 т', fuel: 45 },
      { id: 4, name: 'TR-004', from: 'Москва', to: 'Нижний Новгород', driver: 'Козлов А.Н.', vehicle: 'В321СТ 777', status: 'delayed', progress: 35, lat: 55.9, lng: 40.2, distance: 290, eta: '4ч (опоздание)', cargo: '20 т', fuel: 62 },
      { id: 5, name: 'TR-005', from: 'Екатеринбург', to: 'Челябинск', driver: 'Морозов Д.П.', vehicle: 'Х654УФ 96', status: 'planned', progress: 0, lat: 56.8, lng: 60.6, distance: 210, eta: 'Завтра 08:00', cargo: '25 т', fuel: 95 },
      { id: 6, name: 'TR-006', from: 'Казань', to: 'Самара', driver: 'Волков И.С.', vehicle: 'А987ОП 16', status: 'active', progress: 58, lat: 54.5, lng: 50.5, distance: 180, eta: '3ч 20м', cargo: '19 т', fuel: 55 },
      { id: 7, name: 'TR-007', from: 'Москва', to: 'Воронеж', driver: 'Соколов М.А.', vehicle: 'Р159МН 777', status: 'completed', progress: 100, lat: 51.6, lng: 39.2, distance: 0, eta: 'Доставлено', cargo: '17 т', fuel: 38 },
    ];

    const statusColors = { active: '#10b981', planned: '#3b82f6', completed: '#6b7280', delayed: '#f59e0b' };
    const statusLabels = { active: 'В пути', planned: 'Плановый', completed: 'Завершён', delayed: 'Опоздание' };
    const statusClasses = { active: 'status-active', planned: 'status-planned', completed: 'status-completed', delayed: 'status-delayed' };

    // Add markers to map
    const markers = {};
    trips.forEach(trip => {
      if (trip.lat && trip.lng) {
        const marker = L.marker([trip.lat, trip.lng], {
          icon: L.divIcon({
            className: 'custom-marker',
            html: `<div style="width:36px;height:36px;background:${statusColors[trip.status]};border-radius:50%;display:flex;align-items:center;justify-content:center;color:white;border:3px solid white;box-shadow:0 2px 8px rgba(0,0,0,0.3);"><i class="fa-solid fa-truck" style="font-size:14px;"></i></div>`,
            iconSize: [36, 36],
            iconAnchor: [18, 18]
          })
        }).addTo(map);
        marker.bindPopup(`<b>${trip.name}</b><br>${trip.from} → ${trip.to}<br>Водитель: ${trip.driver}`);
        markers[trip.id] = marker;
      }
    });

    // Draw route line example
    const routeCoords = [[55.7558, 37.6173], [56.8584, 35.9176], [59.9343, 30.3351]];
    L.polyline(routeCoords, { color: '#3b82f6', weight: 3, opacity: 0.7, dashArray: '10, 10' }).addTo(map);

    // Render trip list
    function renderTripList(filter = 'all') {
      const list = document.getElementById('tripList');
      const filtered = filter === 'all' ? trips : trips.filter(t => t.status === filter);
      document.getElementById('tripCount').textContent = `${filtered.length} рейсов`;
      
      list.innerHTML = filtered.map((trip, i) => `
        <div class="trip-card glass-card p-4 ${trip.status} ${i === 0 ? 'selected' : ''}" data-id="${trip.id}">
          <div class="flex items-start justify-between mb-2">
            <div>
              <div class="font-semibold">${trip.name}</div>
              <div class="text-sm text-muted">${trip.from} → ${trip.to}</div>
            </div>
            <span class="status-badge ${statusClasses[trip.status]}">${statusLabels[trip.status]}</span>
          </div>
          <div class="flex items-center justify-between text-xs text-muted">
            <span><i class="fa-solid fa-user mr-1"></i>${trip.driver}</span>
            <span><i class="fa-solid fa-truck mr-1"></i>${trip.vehicle}</span>
          </div>
          <div class="mt-3">
            <div class="flex justify-between text-xs mb-1"><span>Прогресс</span><span>${trip.progress}%</span></div>
            <div class="h-1.5 bg-slate-200 dark:bg-slate-800 rounded-full overflow-hidden">
              <div class="h-full rounded-full" style="width:${trip.progress}%;background:${statusColors[trip.status]}"></div>
            </div>
          </div>
        </div>
      `).join('');

      // Add click handlers
      list.querySelectorAll('.trip-card').forEach(card => {
        card.addEventListener('click', () => {
          list.querySelectorAll('.trip-card').forEach(c => c.classList.remove('selected'));
          card.classList.add('selected');
          const trip = trips.find(t => t.id === parseInt(card.dataset.id));
          if (trip) selectTrip(trip);
        });
      });
    }

    function selectTrip(trip) {
      // Update map
      if (markers[trip.id]) map.setView([trip.lat, trip.lng], 8);
      
      // Update bottom overlay
      document.getElementById('selectedTripName').textContent = `${trip.name} • ${trip.from} → ${trip.to}`;
      document.getElementById('selectedTripDriver').textContent = `Водитель: ${trip.driver}`;
      document.getElementById('selectedTripDistance').textContent = `${trip.distance} км`;
      document.getElementById('selectedTripETA').textContent = trip.eta;
      document.getElementById('selectedTripProgress').textContent = `${trip.progress}%`;

      // Update right panel
      document.getElementById('tripStatusBadge').className = `status-badge ${statusClasses[trip.status]}`;
      document.getElementById('tripStatusBadge').textContent = statusLabels[trip.status];
      document.getElementById('tripProgressValue').textContent = `${trip.progress}%`;
      document.getElementById('detailTripName').textContent = `Рейс ${trip.name}`;
      document.getElementById('detailTripRoute').textContent = `${trip.from} → ${trip.to}`;
      
      // Update progress ring
      const circumference = 251;
      const offset = circumference - (trip.progress / 100) * circumference;
      document.getElementById('progressCircle').setAttribute('stroke-dashoffset', offset);
    }

    // Tab filtering
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderTripList(btn.dataset.filter);
      });
    });

    // Initial render
    renderTripList();
    selectTrip(trips[0]);

    // New Trip Modal
    function showNewTripModal() {
      const modal = document.createElement('div');
      modal.className = 'fixed inset-0 z-50 flex items-center justify-center p-4 bg-black/60 backdrop-blur-sm';
      modal.id = 'newTripModal';
      modal.innerHTML = `
        <div class="glass-panel p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto">
          <div class="flex items-center justify-between mb-6">
            <div class="flex items-center gap-3">
              <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-blue-500 to-emerald-500 flex items-center justify-center">
                <i class="fa-solid fa-route text-white text-lg"></i>
              </div>
              <div>
                <h3 class="text-xl font-bold">Новый рейс</h3>
                <p class="text-sm text-muted">Создание маршрута</p>
              </div>
            </div>
            <button onclick="document.getElementById('newTripModal').remove()" class="icon-btn">
              <i class="fa-solid fa-xmark"></i>
            </button>
          </div>
          
          <form id="newTripForm" class="space-y-5">
            <!-- Route Section -->
            <div class="p-4 rounded-xl bg-white/5 border border-white/10">
              <h4 class="font-semibold mb-4 flex items-center gap-2">
                <i class="fa-solid fa-map-location-dot text-blue-500"></i>
                Маршрут
              </h4>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium mb-2">Откуда</label>
                  <div class="relative">
                    <input type="text" placeholder="Москва, Склад-1" class="input-field w-full pl-10" required>
                    <i class="fa-solid fa-circle text-emerald-500 text-xs absolute left-3 top-1/2 -translate-y-1/2"></i>
                  </div>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Куда</label>
                  <div class="relative">
                    <input type="text" placeholder="Санкт-Петербург, Склад" class="input-field w-full pl-10" required>
                    <i class="fa-solid fa-location-dot text-red-500 text-xs absolute left-3 top-1/2 -translate-y-1/2"></i>
                  </div>
                </div>
              </div>
              <button type="button" class="mt-3 text-sm text-blue-500 hover:text-blue-400 flex items-center gap-2">
                <i class="fa-solid fa-plus"></i>
                Добавить промежуточную точку
              </button>
            </div>

            <!-- Assignment Section -->
            <div class="p-4 rounded-xl bg-white/5 border border-white/10">
              <h4 class="font-semibold mb-4 flex items-center gap-2">
                <i class="fa-solid fa-user-check text-emerald-500"></i>
                Назначение
              </h4>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium mb-2">Водитель</label>
                  <select class="input-field w-full" required>
                    <option value="">Выберите водителя</option>
                    <option value="1">Иванов Алексей (свободен)</option>
                    <option value="2">Петров Сергей (свободен)</option>
                    <option value="3">Сидоров Михаил (в рейсе)</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Транспорт</label>
                  <select class="input-field w-full" required>
                    <option value="">Выберите ТС</option>
                    <option value="1">Volvo FH16 #1</option>
                    <option value="2">MAN TGX #2</option>
                    <option value="3">Scania R500 #3</option>
                  </select>
                </div>
              </div>
            </div>

            <!-- Schedule Section -->
            <div class="p-4 rounded-xl bg-white/5 border border-white/10">
              <h4 class="font-semibold mb-4 flex items-center gap-2">
                <i class="fa-solid fa-calendar text-purple-500"></i>
                Расписание
              </h4>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium mb-2">Дата отправления</label>
                  <input type="datetime-local" class="input-field w-full" required>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Ожидаемое прибытие</label>
                  <input type="datetime-local" class="input-field w-full">
                </div>
              </div>
            </div>

            <!-- Cargo Section -->
            <div class="p-4 rounded-xl bg-white/5 border border-white/10">
              <h4 class="font-semibold mb-4 flex items-center gap-2">
                <i class="fa-solid fa-box text-amber-500"></i>
                Груз
              </h4>
              <div class="grid grid-cols-3 gap-4">
                <div>
                  <label class="block text-sm font-medium mb-2">Тип груза</label>
                  <select class="input-field w-full">
                    <option>Генеральный</option>
                    <option>Сборный</option>
                    <option>Опасный (ADR)</option>
                    <option>Рефрижератор</option>
                  </select>
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Вес (кг)</label>
                  <input type="number" placeholder="10000" class="input-field w-full">
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Объём (м³)</label>
                  <input type="number" placeholder="50" class="input-field w-full">
                </div>
              </div>
            </div>

            <!-- Client Section -->
            <div class="p-4 rounded-xl bg-white/5 border border-white/10">
              <h4 class="font-semibold mb-4 flex items-center gap-2">
                <i class="fa-solid fa-building text-cyan-500"></i>
                Заказчик
              </h4>
              <div class="grid grid-cols-2 gap-4">
                <div>
                  <label class="block text-sm font-medium mb-2">Компания</label>
                  <input type="text" placeholder="ООО Рога и Копыта" class="input-field w-full">
                </div>
                <div>
                  <label class="block text-sm font-medium mb-2">Ставка (₽)</label>
                  <input type="number" placeholder="85000" class="input-field w-full">
                </div>
              </div>
            </div>

            <div class="flex gap-3 pt-4">
              <button type="button" onclick="document.getElementById('newTripModal').remove()" class="btn-secondary flex-1 py-3">
                Отмена
              </button>
              <button type="submit" class="btn-primary flex-1 py-3">
                <i class="fa-solid fa-check mr-2"></i>
                Создать рейс
              </button>
            </div>
          </form>
        </div>
      `;
      document.body.appendChild(modal);
      modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
      
      // Form submit handler
      document.getElementById('newTripForm').addEventListener('submit', (e) => {
        e.preventDefault();
        document.getElementById('newTripModal').remove();
        showTripNotification('Рейс успешно создан!', 'success');
      });
    }

    function showTripNotification(message, type) {
      const colors = { success: 'emerald', error: 'red', warning: 'amber', info: 'blue' };
      const notif = document.createElement('div');
      notif.className = 'fixed bottom-4 right-4 glass-panel px-4 py-3 flex items-center gap-3 z-50';
      notif.innerHTML = `
        <div class="w-8 h-8 rounded-lg bg-${colors[type]}-500/20 flex items-center justify-center">
          <i class="fa-solid fa-check text-${colors[type]}-500"></i>
        </div>
        <span class="font-medium">${message}</span>
      `;
      document.body.appendChild(notif);
      setTimeout(() => { notif.style.opacity = '0'; setTimeout(() => notif.remove(), 300); }, 3000);
    }

    // Profit Calculator Modal
    function showProfitCalculator() {
      const modal = document.createElement('div');
      modal.id = 'profitModal';
      modal.className = 'fixed inset-0 bg-black/60 backdrop-blur-sm z-50 flex items-center justify-center p-4';
      modal.innerHTML = `
        <div class="glass-panel w-full max-w-3xl max-h-[90vh] overflow-auto" onclick="event.stopPropagation()">
          <div class="flex items-center justify-between p-6 border-b border-white/10">
            <div>
              <h2 class="text-xl font-bold">Калькулятор рентабельности</h2>
              <p class="text-sm text-muted mt-1">Расчёт прибыльности рейса</p>
            </div>
            <button onclick="document.getElementById('profitModal').remove()" class="w-10 h-10 rounded-xl bg-white/5 hover:bg-white/10 flex items-center justify-center">
              <i class="fa-solid fa-xmark"></i>
            </button>
          </div>

          <div class="p-6">
            <div class="grid md:grid-cols-2 gap-6">
              <!-- Income Section -->
              <div class="space-y-4">
                <h3 class="font-semibold text-emerald-500 flex items-center gap-2">
                  <i class="fa-solid fa-arrow-trend-up"></i>
                  Доходы
                </h3>
                <div class="space-y-3">
                  <div>
                    <label class="block text-sm font-medium mb-2">Ставка за рейс (₽)</label>
                    <input type="number" id="tripRate" value="85000" class="input-field w-full" onchange="calculateProfit()">
                  </div>
                  <div>
                    <label class="block text-sm font-medium mb-2">Доп. услуги (₽)</label>
                    <input type="number" id="extraServices" value="0" class="input-field w-full" onchange="calculateProfit()">
                  </div>
                  <div>
                    <label class="block text-sm font-medium mb-2">Простой клиента (₽)</label>
                    <input type="number" id="clientPenalty" value="0" class="input-field w-full" onchange="calculateProfit()">
                  </div>
                  <div class="p-4 rounded-xl bg-emerald-500/10 border border-emerald-500/20">
                    <div class="text-sm text-muted">Итого доходы</div>
                    <div class="text-2xl font-bold text-emerald-500" id="totalRevenue">₽ 85,000</div>
                  </div>
                </div>
              </div>

              <!-- Expenses Section -->
              <div class="space-y-4">
                <h3 class="font-semibold text-red-500 flex items-center gap-2">
                  <i class="fa-solid fa-arrow-trend-down"></i>
                  Расходы
                </h3>
                <div class="space-y-3">
                  <div class="grid grid-cols-2 gap-3">
                    <div>
                      <label class="block text-sm font-medium mb-2">Расстояние (км)</label>
                      <input type="number" id="distance" value="680" class="input-field w-full" onchange="calculateProfit()">
                    </div>
                    <div>
                      <label class="block text-sm font-medium mb-2">Расход (л/100км)</label>
                      <input type="number" id="fuelConsumption" value="32" class="input-field w-full" onchange="calculateProfit()">
                    </div>
                  </div>
                  <div class="grid grid-cols-2 gap-3">
                    <div>
                      <label class="block text-sm font-medium mb-2">Цена топлива (₽/л)</label>
                      <input type="number" id="fuelPrice" value="62" class="input-field w-full" onchange="calculateProfit()">
                    </div>
                    <div>
                      <label class="block text-sm font-medium mb-2">Платные дороги (₽)</label>
                      <input type="number" id="tollRoads" value="1200" class="input-field w-full" onchange="calculateProfit()">
                    </div>
                  </div>
                  <div class="grid grid-cols-2 gap-3">
                    <div>
                      <label class="block text-sm font-medium mb-2">ЗП водителя (₽/рейс)</label>
                      <input type="number" id="driverSalary" value="8500" class="input-field w-full" onchange="calculateProfit()">
                    </div>
                    <div>
                      <label class="block text-sm font-medium mb-2">Амортизация (₽)</label>
                      <input type="number" id="depreciation" value="3400" class="input-field w-full" onchange="calculateProfit()">
                    </div>
                  </div>
                  <div>
                    <label class="block text-sm font-medium mb-2">Прочие расходы (₽)</label>
                    <input type="number" id="otherExpenses" value="500" class="input-field w-full" onchange="calculateProfit()">
                  </div>
                  <div class="p-4 rounded-xl bg-red-500/10 border border-red-500/20">
                    <div class="text-sm text-muted">Итого расходы</div>
                    <div class="text-2xl font-bold text-red-500" id="totalExpenses">₽ 27,085</div>
                    <div class="text-xs text-muted mt-1">Топливо: <span id="fuelCost">₽ 13,485</span></div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Results -->
            <div class="mt-6 p-6 rounded-2xl bg-gradient-to-r from-blue-500/10 to-purple-500/10 border border-blue-500/20">
              <div class="grid grid-cols-3 gap-6 text-center">
                <div>
                  <div class="text-sm text-muted mb-1">Чистая прибыль</div>
                  <div class="text-3xl font-bold text-emerald-500" id="netProfit">₽ 57,915</div>
                </div>
                <div>
                  <div class="text-sm text-muted mb-1">Маржинальность</div>
                  <div class="text-3xl font-bold text-blue-500" id="margin">68.1%</div>
                </div>
                <div>
                  <div class="text-sm text-muted mb-1">₽ за километр</div>
                  <div class="text-3xl font-bold text-purple-500" id="perKm">₽ 85.17</div>
                </div>
              </div>
              <div class="mt-4 text-center">
                <div class="text-sm text-muted">Вердикт: <span id="verdict" class="font-bold text-emerald-500">Рейс высокорентабельный</span></div>
              </div>
            </div>

            <!-- Action Buttons -->
            <div class="flex gap-3 mt-6">
              <button onclick="document.getElementById('profitModal').remove()" class="btn-secondary flex-1 py-3">
                Закрыть
              </button>
              <button onclick="saveCalculation()" class="btn-primary flex-1 py-3">
                <i class="fa-solid fa-save mr-2"></i>
                Сохранить расчёт
              </button>
            </div>
          </div>
        </div>
      `;
      document.body.appendChild(modal);
      modal.addEventListener('click', e => { if (e.target === modal) modal.remove(); });
      calculateProfit();
    }

    function calculateProfit() {
      const tripRate = parseFloat(document.getElementById('tripRate')?.value) || 0;
      const extraServices = parseFloat(document.getElementById('extraServices')?.value) || 0;
      const clientPenalty = parseFloat(document.getElementById('clientPenalty')?.value) || 0;
      
      const distance = parseFloat(document.getElementById('distance')?.value) || 0;
      const fuelConsumption = parseFloat(document.getElementById('fuelConsumption')?.value) || 0;
      const fuelPrice = parseFloat(document.getElementById('fuelPrice')?.value) || 0;
      const tollRoads = parseFloat(document.getElementById('tollRoads')?.value) || 0;
      const driverSalary = parseFloat(document.getElementById('driverSalary')?.value) || 0;
      const depreciation = parseFloat(document.getElementById('depreciation')?.value) || 0;
      const otherExpenses = parseFloat(document.getElementById('otherExpenses')?.value) || 0;

      // Calculate
      const totalRevenue = tripRate + extraServices + clientPenalty;
      const fuelCost = (distance / 100) * fuelConsumption * fuelPrice;
      const totalExpenses = fuelCost + tollRoads + driverSalary + depreciation + otherExpenses;
      const netProfit = totalRevenue - totalExpenses;
      const margin = totalRevenue > 0 ? (netProfit / totalRevenue) * 100 : 0;
      const perKm = distance > 0 ? netProfit / distance : 0;

      // Update UI
      document.getElementById('totalRevenue').textContent = `₽ ${totalRevenue.toLocaleString('ru-RU')}`;
      document.getElementById('fuelCost').textContent = `₽ ${fuelCost.toLocaleString('ru-RU', { maximumFractionDigits: 0 })}`;
      document.getElementById('totalExpenses').textContent = `₽ ${totalExpenses.toLocaleString('ru-RU', { maximumFractionDigits: 0 })}`;
      document.getElementById('netProfit').textContent = `₽ ${netProfit.toLocaleString('ru-RU', { maximumFractionDigits: 0 })}`;
      document.getElementById('margin').textContent = `${margin.toFixed(1)}%`;
      document.getElementById('perKm').textContent = `₽ ${perKm.toFixed(2)}`;

      // Color and verdict based on margin
      const profitEl = document.getElementById('netProfit');
      const verdictEl = document.getElementById('verdict');
      
      if (margin >= 30) {
        profitEl.className = 'text-3xl font-bold text-emerald-500';
        verdictEl.className = 'font-bold text-emerald-500';
        verdictEl.textContent = 'Рейс высокорентабельный';
      } else if (margin >= 15) {
        profitEl.className = 'text-3xl font-bold text-amber-500';
        verdictEl.className = 'font-bold text-amber-500';
        verdictEl.textContent = 'Рейс средней рентабельности';
      } else if (margin > 0) {
        profitEl.className = 'text-3xl font-bold text-orange-500';
        verdictEl.className = 'font-bold text-orange-500';
        verdictEl.textContent = 'Рейс низкорентабельный';
      } else {
        profitEl.className = 'text-3xl font-bold text-red-500';
        verdictEl.className = 'font-bold text-red-500';
        verdictEl.textContent = 'Рейс убыточный!';
      }
    }

    function saveCalculation() {
      showTripNotification('Расчёт сохранён!', 'success');
      document.getElementById('profitModal').remove();
    }

    // Bind button
    document.querySelector('.btn-primary').addEventListener('click', showNewTripModal);
  </script>
  <script src="./assets/js/routa-core.js"></script>
  <script src="./assets/js/routox-unified.js"></script>
  <script src="./assets/js/routox-ai.js"></script>
  <script>
    // ========== ROUTA PLATFORM INITIALIZATION ==========
    (async function() {
      Routa.Theme.load();
      const user = await Routa.App.init({
        requireAuth: true,
        currentPage: 'trips.html'
      });
      if (!user) return;
      console.log('Trips page initialized for:', user.role, user.edition);
    })();
    
    function logout() { Routa.Auth.logout(); }
    function toggleTheme() { Routa.Theme.toggle(); }
  </script>
  <script src="./assets/js/role-theme.js"></script>
  <script src="./assets/js/smooth-navigation.js"></script>
</body>
</html>
