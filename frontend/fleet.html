<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>RoutoX — Флот</title>
  <link rel="stylesheet" href="./assets/css/routox-unified.css">
  <script src="https://cdn.tailwindcss.com?plugins=forms"></script>
  <script src="https://kit.fontawesome.com/a2e0e9e5a9.js" crossorigin="anonymous"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <style>
    /* Fleet page specific styles */
    #fleetMap { border-radius: 16px; z-index: 1; height: 400px; }
    .leaflet-control-zoom { border: none !important; border-radius: 10px !important; overflow: hidden; }
    .leaflet-control-zoom a { background: var(--bg-secondary) !important; color: var(--text-primary) !important; border: 1px solid var(--border-color) !important; }

    .vehicle-card {
      transition: all 0.3s ease;
      cursor: pointer;
      position: relative;
      overflow: hidden;
    }

    .vehicle-card::before {
      content: '';
      position: absolute;
      left: 0;
      top: 0;
      bottom: 0;
      width: 4px;
      border-radius: 4px 0 0 4px;
      transition: all 0.3s ease;
    }

    .vehicle-card.online::before { background: linear-gradient(180deg, #10b981, #059669); }
    .vehicle-card.offline::before { background: #6b7280; }
    .vehicle-card.maintenance::before { background: #f59e0b; }
    .vehicle-card.alert::before { background: #ef4444; }

    .vehicle-card:hover {
      transform: translateX(4px);
      border-color: rgba(59, 130, 246, 0.4);
    }

    .vehicle-card.selected {
      border-color: rgba(59, 130, 246, 0.6);
      background: rgba(59, 130, 246, 0.05);
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      animation: pulse 2s ease-in-out infinite;
    }

    .status-dot.online { background: #10b981; box-shadow: 0 0 10px rgba(16, 185, 129, 0.5); }
    .status-dot.offline { background: #6b7280; animation: none; }
    .status-dot.maintenance { background: #f59e0b; }
    .status-dot.alert { background: #ef4444; }

    @keyframes pulse {
      0%, 100% { opacity: 1; transform: scale(1); }
      50% { opacity: 0.7; transform: scale(1.1); }
    }

    .metric-card {
      position: relative;
      overflow: hidden;
    }

    .metric-card::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #3b82f6, #10b981);
      transform: scaleX(0);
      transition: transform 0.3s ease;
    }

    .metric-card:hover::after {
      transform: scaleX(1);
    }

    .kpi-value {
      background: linear-gradient(135deg, #3b82f6, #10b981);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .truck-3d {
      perspective: 500px;
    }

    .truck-3d-inner {
      transform-style: preserve-3d;
      animation: truckFloat 4s ease-in-out infinite;
    }

    @keyframes truckFloat {
      0%, 100% { transform: rotateY(-5deg) rotateX(5deg) translateY(0); }
      50% { transform: rotateY(5deg) rotateX(-5deg) translateY(-10px); }
    }

    .progress-bar {
      height: 8px;
      background: var(--border-color);
      border-radius: 4px;
      overflow: hidden;
    }

    .progress-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.5s ease;
    }

    .progress-fill.excellent { background: linear-gradient(90deg, #10b981, #34d399); }
    .progress-fill.good { background: linear-gradient(90deg, #3b82f6, #60a5fa); }
    .progress-fill.warning { background: linear-gradient(90deg, #f59e0b, #fbbf24); }
    .progress-fill.critical { background: linear-gradient(90deg, #ef4444, #f87171); }

    /* 3D Truck Icon SVG */
    .truck-icon-3d {
      filter: drop-shadow(0 10px 20px rgba(59, 130, 246, 0.3));
    }

    /* Role badge */
    .role-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }

    .role-badge.admin {
      background: rgba(59, 130, 246, 0.15);
      color: #3b82f6;
      border: 1px solid rgba(59, 130, 246, 0.3);
    }

    .role-badge.owner {
      background: rgba(139, 92, 246, 0.15);
      color: #8b5cf6;
      border: 1px solid rgba(139, 92, 246, 0.3);
    }

    .stat-value {
      font-size: 28px;
      font-weight: 700;
      background: linear-gradient(135deg, #3b82f6, #10b981);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
    }

    .live-pulse { animation: pulse 2s ease-in-out infinite; }

    .tab-btn { 
      padding: 8px 16px; 
      border-radius: 10px; 
      font-size: 13px; 
      color: var(--text-secondary); 
      transition: all 0.2s ease; 
      font-weight: 500; 
    }
    .tab-btn:hover { color: #3b82f6; background: rgba(59, 130, 246, 0.08); }
    .tab-btn.active { background: linear-gradient(135deg, #3b82f6, #2563eb); color: white; }
  </style>
</head>
<body class="min-h-screen">
  <!-- Header -->
  <header class="glass-panel mx-4 mt-4 px-6 py-4 flex items-center justify-between sticky top-4 z-30">
    <div class="flex items-center gap-6">
      <a href="./fleet.html" class="flex items-center gap-3">
        <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center text-white font-bold text-lg shadow-lg">R</div>
        <div>
          <div class="font-semibold text-lg">RoutoX</div>
          <div class="text-xs text-muted">Управление флотом</div>
        </div>
      </a>
      <nav class="flex gap-2">
        <a href="./fleet.html" class="nav-pill active"><i class="fa-solid fa-truck"></i><span>Флот</span></a>
        <a href="./trips.html" class="nav-pill"><i class="fa-solid fa-route"></i><span>Рейсы</span></a>
        <a href="./geozones.html" class="nav-pill"><i class="fa-solid fa-map-location-dot"></i><span>Геозоны</span></a>
        <a href="./analytics.html" class="nav-pill"><i class="fa-solid fa-chart-line"></i><span>Аналитика</span></a>
        <a href="./fuel.html" class="nav-pill"><i class="fa-solid fa-gas-pump"></i><span>Топливо</span></a>
        <a href="./maintenance.html" class="nav-pill"><i class="fa-solid fa-wrench"></i><span>ТО</span></a>
        <a href="./documents.html" class="nav-pill"><i class="fa-solid fa-file-lines"></i><span>Документы</span></a>
      </nav>
    </div>
    <div class="flex items-center gap-3">
      <div class="flex items-center gap-2 px-3 py-2 rounded-xl bg-emerald-500/15 border border-emerald-500/30">
        <span class="w-2 h-2 rounded-full bg-emerald-500 live-pulse"></span>
        <span class="text-sm text-emerald-600 font-medium">Live</span>
      </div>
      <span class="role-badge admin" id="roleBadge">
        <i class="fa-solid fa-user-gear"></i>
        <span id="roleText">Администратор</span>
      </span>
      <button class="icon-btn" id="notifBtn">
        <i class="fa-solid fa-bell"></i>
        <span class="absolute -top-1 -right-1 w-4 h-4 bg-red-500 rounded-full text-[10px] text-white flex items-center justify-center">3</span>
      </button>
      <div class="theme-toggle-track" onclick="toggleTheme()">
        <div class="theme-toggle-thumb"></div>
      </div>
      <button class="icon-btn" onclick="logout()">
        <i class="fa-solid fa-right-from-bracket"></i>
      </button>
    </div>
  </header>

  <!-- Main Content -->
  <main class="p-4 grid lg:grid-cols-[340px_1fr] gap-4">
    <!-- Left Sidebar - Vehicle List -->
    <div class="space-y-4">
      <!-- Stats -->
      <div class="glass-panel p-4">
        <div class="grid grid-cols-4 gap-2">
          <div class="stat-card glass-card p-3 text-center">
            <div class="stat-value" id="onlineCount">12</div>
            <div class="text-xs text-muted mt-1">Онлайн</div>
          </div>
          <div class="stat-card glass-card p-3 text-center">
            <div class="stat-value" id="offlineCount">3</div>
            <div class="text-xs text-muted mt-1">Офлайн</div>
          </div>
          <div class="stat-card glass-card p-3 text-center">
            <div class="stat-value" id="maintenanceCount">2</div>
            <div class="text-xs text-muted mt-1">На ТО</div>
          </div>
          <div class="stat-card glass-card p-3 text-center">
            <div class="stat-value" id="alertCount">1</div>
            <div class="text-xs text-muted mt-1">Тревога</div>
          </div>
        </div>
      </div>

      <!-- Search & Filter -->
      <div class="glass-panel p-4">
        <div class="relative mb-3">
          <i class="fa-solid fa-search absolute left-3 top-1/2 -translate-y-1/2 text-muted"></i>
          <input type="text" placeholder="Поиск по номеру, водителю..." class="input-field w-full pl-10" id="searchInput">
        </div>
        <div class="flex gap-2">
          <button class="tab-btn active" data-filter="all">Все</button>
          <button class="tab-btn" data-filter="online">Онлайн</button>
          <button class="tab-btn" data-filter="offline">Офлайн</button>
          <button class="tab-btn" data-filter="alert">Тревога</button>
        </div>
      </div>

      <!-- Vehicle List -->
      <div class="glass-panel p-4 max-h-[50vh] overflow-y-auto custom-scroll" id="vehicleList">
        <!-- Vehicle cards will be inserted here -->
      </div>

      <!-- Add Vehicle Button -->
      <button class="btn-primary w-full flex items-center justify-center gap-2" onclick="openAddVehicleModal()">
        <i class="fa-solid fa-plus"></i>
        Добавить транспорт
      </button>
    </div>

    <!-- Right Content Area -->
    <div class="space-y-4">
      <!-- Selected Vehicle Hero -->
      <div class="glass-panel p-6" id="vehicleHero">
        <div class="grid lg:grid-cols-2 gap-6">
          <!-- Vehicle Info -->
          <div class="space-y-4">
            <div class="flex items-center gap-4">
              <div class="truck-3d">
                <div class="truck-3d-inner">
                  <svg width="100" height="60" viewBox="0 0 100 60" class="truck-icon-3d">
                    <defs>
                      <linearGradient id="truckGrad" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#3b82f6"/>
                        <stop offset="100%" style="stop-color:#2563eb"/>
                      </linearGradient>
                    </defs>
                    <rect x="30" y="10" width="65" height="35" rx="4" fill="url(#truckGrad)"/>
                    <rect x="5" y="20" width="30" height="25" rx="3" fill="#60a5fa"/>
                    <rect x="10" y="23" width="20" height="12" rx="2" fill="#0ea5e9"/>
                    <circle cx="20" cy="50" r="8" fill="#1e293b" stroke="#475569" stroke-width="2"/>
                    <circle cx="50" cy="50" r="8" fill="#1e293b" stroke="#475569" stroke-width="2"/>
                    <circle cx="80" cy="50" r="8" fill="#1e293b" stroke="#475569" stroke-width="2"/>
                  </svg>
                </div>
              </div>
              <div>
                <div class="text-2xl font-bold" id="heroName">MAN TGX 18.500</div>
                <div class="text-muted" id="heroPlate">А 123 ВС 116</div>
                <div class="flex items-center gap-2 mt-2">
                  <span class="status-dot online" id="heroStatus"></span>
                  <span class="text-sm" id="heroStatusText">В пути</span>
                </div>
              </div>
            </div>

            <!-- Driver Info -->
            <div class="glass-card p-4">
              <div class="flex items-center gap-4">
                <div class="avatar w-12 h-12 rounded-full bg-gradient-to-br from-blue-500 to-blue-600 flex items-center justify-center text-white font-bold" id="driverAvatar">АМ</div>
                <div class="flex-1">
                  <div class="font-semibold" id="driverName">Артём Малышев</div>
                  <div class="text-sm text-muted" id="driverStatus">На линии · 4ч 12м</div>
                </div>
                <a href="tel:" class="icon-btn" id="driverCall">
                  <i class="fa-solid fa-phone"></i>
                </a>
              </div>
            </div>

            <!-- Quick Stats -->
            <div class="grid grid-cols-3 gap-3">
              <div class="glass-card p-3 text-center">
                <div class="text-xs text-muted">Скорость</div>
                <div class="text-xl font-bold" id="heroSpeed">68</div>
                <div class="text-xs text-muted">км/ч</div>
              </div>
              <div class="glass-card p-3 text-center">
                <div class="text-xs text-muted">До цели</div>
                <div class="text-xl font-bold" id="heroEta">4.5</div>
                <div class="text-xs text-muted">часов</div>
              </div>
              <div class="glass-card p-3 text-center">
                <div class="text-xs text-muted">Пробег</div>
                <div class="text-xl font-bold" id="heroDistance">312</div>
                <div class="text-xs text-muted">км</div>
              </div>
            </div>

            <!-- Progress Bars -->
            <div class="space-y-3">
              <div>
                <div class="flex justify-between text-sm mb-1">
                  <span>Топливо</span>
                  <span id="fuelPercent">72%</span>
                </div>
                <div class="progress-bar">
                  <div class="progress-fill good" style="width: 72%" id="fuelBar"></div>
                </div>
              </div>
              <div>
                <div class="flex justify-between text-sm mb-1">
                  <span>Загрузка</span>
                  <span id="loadPercent">85%</span>
                </div>
                <div class="progress-bar">
                  <div class="progress-fill excellent" style="width: 85%" id="loadBar"></div>
                </div>
              </div>
              <div>
                <div class="flex justify-between text-sm mb-1">
                  <span>Состояние ТС</span>
                  <span id="healthPercent">94%</span>
                </div>
                <div class="progress-bar">
                  <div class="progress-fill excellent" style="width: 94%" id="healthBar"></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Map -->
          <div>
            <div id="fleetMap" class="rounded-xl"></div>
            <div class="grid grid-cols-3 gap-3 mt-4">
              <div class="glass-card p-3">
                <div class="flex items-center gap-2 mb-1">
                  <div class="w-2 h-2 rounded-full bg-emerald-500"></div>
                  <span class="text-xs text-muted">Откуда</span>
                </div>
                <div class="font-medium" id="routeFrom">Казань</div>
              </div>
              <div class="glass-card p-3">
                <div class="flex items-center gap-2 mb-1">
                  <i class="fa-solid fa-road text-xs text-blue-500"></i>
                  <span class="text-xs text-muted">Маршрут</span>
                </div>
                <div class="font-medium" id="routeCode">М7-Р239</div>
              </div>
              <div class="glass-card p-3">
                <div class="flex items-center gap-2 mb-1">
                  <div class="w-2 h-2 rounded-full bg-orange-500"></div>
                  <span class="text-xs text-muted">Куда</span>
                </div>
                <div class="font-medium" id="routeTo">Минск</div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Bottom Grid -->
      <div class="grid lg:grid-cols-3 gap-4">
        <!-- Cargo Info -->
        <div class="glass-card p-4">
          <h3 class="font-semibold flex items-center gap-2 mb-4">
            <i class="fa-solid fa-boxes-stacked text-blue-500"></i>
            Груз
          </h3>
          <div class="space-y-3">
            <div class="flex justify-between">
              <span class="text-muted">Тип груза</span>
              <span class="font-medium" id="cargoType">Электроника</span>
            </div>
            <div class="flex justify-between">
              <span class="text-muted">Вес</span>
              <span class="font-medium" id="cargoWeight">18.5 т</span>
            </div>
            <div class="flex justify-between">
              <span class="text-muted">Паллеты</span>
              <span class="font-medium" id="cargoPallets">28 / 38</span>
            </div>
            <div class="flex justify-between">
              <span class="text-muted">Стоимость</span>
              <span class="font-medium text-emerald-500" id="cargoValue">₽ 2.4 млн</span>
            </div>
          </div>
        </div>

        <!-- Temperature -->
        <div class="glass-card p-4">
          <h3 class="font-semibold flex items-center gap-2 mb-4">
            <i class="fa-solid fa-temperature-half text-orange-500"></i>
            Температура
          </h3>
          <div class="text-center py-4">
            <div class="text-4xl font-bold" id="tempValue">+4°C</div>
            <div class="text-sm text-muted mt-2">Норма: от +2° до +8°</div>
            <div class="badge badge-success mt-2">
              <i class="fa-solid fa-check mr-1"></i>В норме
            </div>
          </div>
        </div>

        <!-- Recent Events -->
        <div class="glass-card p-4">
          <h3 class="font-semibold flex items-center gap-2 mb-4">
            <i class="fa-solid fa-clock-rotate-left text-purple-500"></i>
            События
          </h3>
          <div class="space-y-3 text-sm" id="eventsList">
            <div class="flex items-center gap-3">
              <div class="w-2 h-2 rounded-full bg-emerald-500"></div>
              <div class="flex-1">
                <div>Прошёл КПП Казань</div>
                <div class="text-xs text-muted">12:45</div>
              </div>
            </div>
            <div class="flex items-center gap-3">
              <div class="w-2 h-2 rounded-full bg-blue-500"></div>
              <div class="flex-1">
                <div>Заправка на АЗС Лукойл</div>
                <div class="text-xs text-muted">11:30</div>
              </div>
            </div>
            <div class="flex items-center gap-3">
              <div class="w-2 h-2 rounded-full bg-orange-500"></div>
              <div class="flex-1">
                <div>Отдых водителя (45 мин)</div>
                <div class="text-xs text-muted">10:00</div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </main>

  <!-- Add Vehicle Modal -->
  <div class="modal-backdrop hidden" id="addVehicleModal">
    <div class="glass-panel p-6 w-full max-w-lg m-4">
      <div class="flex items-center justify-between mb-6">
        <h2 class="text-xl font-bold">Добавить транспорт</h2>
        <button onclick="closeAddVehicleModal()" class="icon-btn">
          <i class="fa-solid fa-xmark"></i>
        </button>
      </div>
      <form id="addVehicleForm" class="space-y-4">
        <div>
          <label class="block text-sm font-medium mb-2">Госномер</label>
          <input type="text" class="input-field w-full" placeholder="А 123 ВС 116" required>
        </div>
        <div>
          <label class="block text-sm font-medium mb-2">Модель</label>
          <input type="text" class="input-field w-full" placeholder="MAN TGX 18.500" required>
        </div>
        <div>
          <label class="block text-sm font-medium mb-2">VIN</label>
          <input type="text" class="input-field w-full" placeholder="WMA12345678901234">
        </div>
        <div>
          <label class="block text-sm font-medium mb-2">Водитель</label>
          <select class="input-field w-full">
            <option value="">Выберите водителя</option>
            <option>Артём Малышев</option>
            <option>Сергей Иванов</option>
            <option>Дмитрий Козлов</option>
          </select>
        </div>
        <div class="flex gap-3 pt-4">
          <button type="button" onclick="closeAddVehicleModal()" class="flex-1 px-4 py-3 rounded-xl border border-gray-300 dark:border-gray-600 font-medium">
            Отмена
          </button>
          <button type="submit" class="btn-primary flex-1">
            Добавить
          </button>
        </div>
      </form>
    </div>
  </div>

  <script src="./assets/js/routox-unified.js"></script>
  <script>
    // Sample vehicle data
    const vehicles = [
      { id: 1, plate: 'А 123 ВС 116', model: 'MAN TGX 18.500', status: 'online', driver: 'Артём Малышев', speed: 68, fuel: 72, load: 85, health: 94, from: 'Казань', to: 'Минск', lat: 55.45, lng: 49.12 },
      { id: 2, plate: 'В 456 ЕК 116', model: 'Volvo FH16', status: 'online', driver: 'Сергей Иванов', speed: 72, fuel: 45, load: 60, health: 88, from: 'Москва', to: 'СПб', lat: 55.75, lng: 37.62 },
      { id: 3, plate: 'С 789 НМ 116', model: 'Scania R500', status: 'maintenance', driver: 'Дмитрий Козлов', speed: 0, fuel: 90, load: 0, health: 45, from: '-', to: '-', lat: 55.30, lng: 49.05 },
      { id: 4, plate: 'Е 012 РС 116', model: 'DAF XF', status: 'offline', driver: 'Алексей Петров', speed: 0, fuel: 30, load: 0, health: 92, from: '-', to: '-', lat: 54.98, lng: 48.80 },
      { id: 5, plate: 'К 345 ТУ 116', model: 'Mercedes Actros', status: 'online', driver: 'Михаил Сидоров', speed: 85, fuel: 68, load: 95, health: 97, from: 'Нижний', to: 'Самара', lat: 56.32, lng: 44.00 },
      { id: 6, plate: 'М 678 ФХ 116', model: 'Iveco Stralis', status: 'alert', driver: 'Виктор Новиков', speed: 45, fuel: 15, load: 70, health: 78, from: 'Уфа', to: 'Челябинск', lat: 54.73, lng: 55.97 },
      { id: 7, plate: 'Н 901 ЦЧ 116', model: 'MAN TGS', status: 'online', driver: 'Андрей Белов', speed: 55, fuel: 82, load: 100, health: 91, from: 'Екб', to: 'Пермь', lat: 56.84, lng: 60.60 },
      { id: 8, plate: 'О 234 ШЩ 116', model: 'Volvo FM', status: 'offline', driver: 'Павел Черных', speed: 0, fuel: 65, load: 0, health: 85, from: '-', to: '-', lat: 55.03, lng: 82.92 },
    ];

    let selectedVehicle = vehicles[0];
    let map = null;
    let markers = [];

    // Initialize
    document.addEventListener('DOMContentLoaded', () => {
      initTheme();
      checkRole();
      renderVehicleList();
      selectVehicle(vehicles[0]);
      initMap();
      updateStats();
    });

    // Check user role
    function checkRole() {
      const role = localStorage.getItem('user_role') || 'admin';
      const roleBadge = document.getElementById('roleBadge');
      const roleText = document.getElementById('roleText');
      
      if (role === 'owner') {
        roleBadge.className = 'role-badge owner';
        roleText.textContent = 'Владелец';
        roleBadge.querySelector('i').className = 'fa-solid fa-crown';
      } else {
        roleBadge.className = 'role-badge admin';
        roleText.textContent = 'Администратор';
        roleBadge.querySelector('i').className = 'fa-solid fa-user-gear';
      }
    }

    // Update stats
    function updateStats() {
      document.getElementById('onlineCount').textContent = vehicles.filter(v => v.status === 'online').length;
      document.getElementById('offlineCount').textContent = vehicles.filter(v => v.status === 'offline').length;
      document.getElementById('maintenanceCount').textContent = vehicles.filter(v => v.status === 'maintenance').length;
      document.getElementById('alertCount').textContent = vehicles.filter(v => v.status === 'alert').length;
    }

    // Render vehicle list
    function renderVehicleList(filter = 'all') {
      const container = document.getElementById('vehicleList');
      const filtered = filter === 'all' ? vehicles : vehicles.filter(v => v.status === filter);
      
      container.innerHTML = filtered.map(v => `
        <div class="glass-card vehicle-card ${v.status} p-4 mb-3 ${selectedVehicle?.id === v.id ? 'selected' : ''}" onclick="selectVehicle(vehicles.find(x => x.id === ${v.id}))">
          <div class="flex items-center gap-4">
            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-slate-100 to-slate-200 dark:from-slate-700 dark:to-slate-800 flex items-center justify-center">
              <i class="fa-solid fa-truck text-xl ${v.status === 'online' ? 'text-emerald-500' : v.status === 'alert' ? 'text-red-500' : v.status === 'maintenance' ? 'text-amber-500' : 'text-slate-400'}"></i>
            </div>
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2">
                <span class="font-semibold">${v.plate}</span>
                <span class="status-dot ${v.status}"></span>
              </div>
              <div class="text-sm text-muted truncate">${v.model}</div>
              <div class="text-xs text-muted">${v.driver}</div>
            </div>
            <div class="text-right">
              <div class="text-lg font-bold">${v.speed}</div>
              <div class="text-xs text-muted">км/ч</div>
            </div>
          </div>
        </div>
      `).join('');
    }

    // Select vehicle
    function selectVehicle(vehicle) {
      selectedVehicle = vehicle;
      
      document.getElementById('heroName').textContent = vehicle.model;
      document.getElementById('heroPlate').textContent = vehicle.plate;
      document.getElementById('heroStatus').className = `status-dot ${vehicle.status}`;
      
      const statusTexts = { online: 'В пути', maintenance: 'На ТО', alert: 'Тревога', offline: 'Офлайн' };
      document.getElementById('heroStatusText').textContent = statusTexts[vehicle.status] || 'Неизвестно';
      
      document.getElementById('driverName').textContent = vehicle.driver;
      document.getElementById('driverAvatar').textContent = vehicle.driver.split(' ').map(n => n[0]).join('');
      
      document.getElementById('heroSpeed').textContent = vehicle.speed;
      document.getElementById('fuelPercent').textContent = vehicle.fuel + '%';
      document.getElementById('fuelBar').style.width = vehicle.fuel + '%';
      document.getElementById('fuelBar').className = `progress-fill ${vehicle.fuel > 50 ? 'good' : vehicle.fuel > 25 ? 'warning' : 'critical'}`;
      
      document.getElementById('loadPercent').textContent = vehicle.load + '%';
      document.getElementById('loadBar').style.width = vehicle.load + '%';
      
      document.getElementById('healthPercent').textContent = vehicle.health + '%';
      document.getElementById('healthBar').style.width = vehicle.health + '%';
      document.getElementById('healthBar').className = `progress-fill ${vehicle.health > 80 ? 'excellent' : vehicle.health > 50 ? 'good' : 'warning'}`;
      
      document.getElementById('routeFrom').textContent = vehicle.from;
      document.getElementById('routeTo').textContent = vehicle.to;
      
      renderVehicleList(document.querySelector('.tab-btn.active')?.dataset.filter || 'all');
      
      if (map) {
        map.setView([vehicle.lat, vehicle.lng], 8);
      }
    }

    // Initialize map
    function initMap() {
      map = L.map('fleetMap').setView([55.45, 49.12], 5);
      
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '© OpenStreetMap'
      }).addTo(map);
      
      vehicles.forEach(v => {
        const color = v.status === 'online' ? '#10b981' : v.status === 'alert' ? '#ef4444' : v.status === 'maintenance' ? '#f59e0b' : '#6b7280';
        const marker = L.circleMarker([v.lat, v.lng], {
          radius: 10,
          fillColor: color,
          color: '#fff',
          weight: 2,
          fillOpacity: 0.8
        }).addTo(map);
        
        marker.bindPopup(`<b>${v.plate}</b><br>${v.model}<br>${v.driver}`);
        marker.on('click', () => selectVehicle(v));
        markers.push(marker);
      });
    }

    // Filter handlers
    document.querySelectorAll('.tab-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        renderVehicleList(btn.dataset.filter);
      });
    });

    // Search
    document.getElementById('searchInput').addEventListener('input', (e) => {
      const query = e.target.value.toLowerCase();
      const filtered = vehicles.filter(v => 
        v.plate.toLowerCase().includes(query) || 
        v.driver.toLowerCase().includes(query) ||
        v.model.toLowerCase().includes(query)
      );
      
      const container = document.getElementById('vehicleList');
      container.innerHTML = filtered.map(v => `
        <div class="glass-card vehicle-card ${v.status} p-4 mb-3 ${selectedVehicle?.id === v.id ? 'selected' : ''}" onclick="selectVehicle(vehicles.find(x => x.id === ${v.id}))">
          <div class="flex items-center gap-4">
            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-slate-100 to-slate-200 dark:from-slate-700 dark:to-slate-800 flex items-center justify-center">
              <i class="fa-solid fa-truck text-xl ${v.status === 'online' ? 'text-emerald-500' : v.status === 'alert' ? 'text-red-500' : v.status === 'maintenance' ? 'text-amber-500' : 'text-slate-400'}"></i>
            </div>
            <div class="flex-1 min-w-0">
              <div class="flex items-center gap-2">
                <span class="font-semibold">${v.plate}</span>
                <span class="status-dot ${v.status}"></span>
              </div>
              <div class="text-sm text-muted truncate">${v.model}</div>
              <div class="text-xs text-muted">${v.driver}</div>
            </div>
            <div class="text-right">
              <div class="text-lg font-bold">${v.speed}</div>
              <div class="text-xs text-muted">км/ч</div>
            </div>
          </div>
        </div>
      `).join('');
    });

    // Modal handlers
    function openAddVehicleModal() {
      document.getElementById('addVehicleModal').classList.remove('hidden');
    }

    function closeAddVehicleModal() {
      document.getElementById('addVehicleModal').classList.add('hidden');
    }

    // Logout
    function logout() {
      localStorage.removeItem('auth_token');
      localStorage.removeItem('user_role');
      localStorage.removeItem('demo_mode');
      window.location.href = './login.html';
    }
  </script>
</body>
</html>
