# ТЗ: Routa Platform (RoutaL / RoutaT / RoutaX / RoutaF / RoutaE / RoutaS)
Дата: 2026-01-06  
Версия: 1.0  
Статус: Draft for implementation

---

## 0) Цель и принцип
Нужно реализовать **единую, стабильную, без багов платформу** Routa для управления транспортной деятельностью, в которой “продукты” (RoutaL/T/X/…) — это **издания (editions)**, включающие/ограничивающие функциональность через **feature flags**, а не отдельные сайты/кодовые базы.

Критерий успеха: любой пользователь (owner/admin/driver/platform_admin) может **логиниться, переключаться между разделами, работать в light/dark**, видеть корректный набор вкладок и данных по роли/изданию без “прыжков роли”, без 502/500, без пропажи навигации и иконок.

---

## 1) Роли, доступы, вкладки (строго)

### 1.1 Роли платформы (владелец SaaS)
- `platform_admin`: доступ к SaaS Admin панели (тенанты, биллинг, usage, логи, feature flags).
- `support` (опционально): read-only + инструменты поддержки (без финансов).

### 1.2 Роли внутри компании (tenant)
- `owner`
- `admin`
- `dispatcher` (опционально)
- `driver`

### 1.3 Вкладки и порядок (строго; не менять)
**Owner:**
1) Персонал  
2) Флот  
3) Рейсы  
4) Геозоны  
5) Аналитика  
6) Топливо  
7) ТО  
8) Документы  
9) Инвентарь

**Admin:**
1) Флот  
2) Рейсы  
3) Геозоны  
4) Аналитика *(ограниченная)*  
5) Топливо  
6) ТО  
7) Документы  
8) Инвентарь

**Driver:**
- водительский кабинет (driver dashboard)
- “Мои рейсы”, “Мои документы” (если включено), “Мои уведомления”
- не видит “Персонал” и бизнес-аналитику

> Правило: **издание/тариф может скрывать целый модуль**, но **порядок оставшихся вкладок сохраняется**.  
> Правило: **роль не должна изменяться при переходах между страницами**.

---

## 2) Multi-product модель (editions + plans + feature flags)

### 2.1 Editions (продукты)
- **RoutaL** (Little): малые компании (1–10 ТС), “порядок вместо Excel”
- **RoutaT** (Town): город/смены/стройка/точки, контроль простоя и выполнения
- **RoutaX** (Intercity): межгород/дальняк, экономика рейса, РТО/комплаенс
- **RoutaF** (Forwarder): экспедитор, подрядчики, buy/sell, SLA
- **RoutaE** (Enterprise): холдинги, SSO, аудит, интеграции, SLA
- **RoutaS** (Subcontractor): кабинет исполнителя/подрядчика (моб/веб)

### 2.2 Plans (тарифные планы)
Рекомендуемая сетка (можно менять названия):
- `start`, `pro`, `business`  
Каждый plan задаёт лимиты (ТС/пользователи/интеграции/экспорт/AI) и доступы.

### 2.3 Feature flags
Для каждой компании хранится:
- `product_edition`
- `plan`
- `features` (набор модулей и опций)

Фронт строит меню и экраны на основе:
- `role` (из `/me`)
- `edition` и `features` (из `/features/me` или в составе `/me`)

---

## 3) Регистрация, создание компании, приглашения (onboarding)

### 3.1 Сценарий A: регистрация владельца и создание компании
1) Пользователь регистрируется (email/phone + пароль).
2) Выбирает продукт (RoutaL/T/X/F/E).
3) Создаёт компанию:
   - Название, часовой пояс, валюта, регион.
4) Мастер онбординга (обязательно):
   - добавить/импортировать 1 ТС
   - добавить 1 водителя
   - создать 1 рейс
   - включить 1 уведомление (например, ТО)
5) Приглашение пользователей:
   - админы/диспетчеры по email (invite link)
   - водители через invite link + одноразовый PIN/OTP (упрощённый вход)

### 3.2 Сценарий B: присоединение по приглашению
- Пользователь открывает invite link → задаёт пароль/подтверждает → входит в компанию.
- Инвайт:
  - ограниченный срок действия
  - одноразовый/ограниченный по активациям
  - фиксированная роль

### 3.3 Ограничения
- Водитель не может сам создавать компанию (только через приглашение).
- Пользователь может состоять в нескольких компаниях (опционально), но “активная компания” явно выбирается.
- Любая смена активной компании отражается в `/me` и в UI.

---

## 4) База качества (must-have foundation)

### 4.1 Авторизация и сессии
- Логин должен быть стабилен (никаких 502 из-за импорта/seed/логирования).
- При новом логине:
  - очищается старая сессия (access/refresh токены + user cache + active company)
  - корректно обновляется роль, вкладки и доступы.
- 401 → очистка сессии + редирект на login  
- 403 → экран “Нет доступа” + кнопка “Перейти на доступный раздел”

### 4.2 Навигация (критически важно)
На **каждой странице приложения**:
- присутствует header с вкладками (верхнее меню)
- есть иконка “Уведомления”
- есть иконка “Настройки”
- есть переключатель темы
- есть кнопка “Выход”
- переходы работают всегда (без “пропали кнопки / не кликается”)

### 4.3 Тема (light/dark)
- По умолчанию везде **light**.
- Единый ключ хранения темы (например `routox_theme`) на всех страницах.
- Тема применяется **до рендера** (без “мигания”).
- Любая страница корректно отображается в light и dark.

### 4.4 Иконки/логотипы
- Иконки настроек и уведомлений должны быть:
  - локальные SVG (предпочтительно) либо гарантированно загружаемый пакет без CDN-зависимости.
- Для каждого продукта требуется логотип (SVG):
  - RoutaX, RoutaL, RoutaT, RoutaF, RoutaE, RoutaS
- На лендинге и в интерфейсе отображается активный продукт компании.

---

## 5) Модули системы (минимальные требования)

### 5.1 Флот
- список ТС, поиск/фильтры, карточка ТС
- привязка водителя (если применимо)
- статусы (в работе/на ТО/свободен)
- импорт/экспорт CSV (планы выше `start` — опционально)

### 5.2 Рейсы
- список, статусы, водитель/ТС, точки/маршрут (минимум: откуда/куда/дата)
- таймлайн событий по рейсу
- привязка документов
- для RoutaX: экономика рейса (план/факт, маржа, причины отклонений)

### 5.3 Геозоны
- список геозон, создание/редактирование
- триггеры уведомлений (въезд/выезд)

### 5.4 Аналитика
- Owner: полный набор KPI по продукту
- Admin: “ограниченная” аналитика (без итоговой бизнес-аналитики владельца)
- Driver: аналитика отсутствует (кроме личных показателей в кабинете)

### 5.5 Топливо
- записи расхода, сверка с нормой (L/T базово)
- для RoutaX: аномалии, сверка с пробегом/интеграциями (если включено)

### 5.6 ТО
- план/факт работ, напоминания, статусы

### 5.7 Документы
- список, статусы, прикрепление к рейсам
- роли: driver видит только свои/по назначенным рейсам

### 5.8 Инвентарь
- единый UI-стандарт, не “вылетает”
- CRUD позиций, остатки, предупреждения “заканчивается”
- права: driver по умолчанию read-only или вовсе скрыт (настраивается флагами)

### 5.9 Уведомления
- красивый UI, уведомления видны сразу (skeleton/loading)
- фильтрация по роли:
  - driver: только личные (рейсы/РТО/его документы)
  - admin/owner: системные (ТО/топливо/инвентарь/документы)
- состояния: прочитано/не прочитано, приоритет

### 5.10 AI помощник
- виджет доступен на всех страницах, всегда видим
- поддерживает light/dark
- отвечает на базовые вопросы по роли и текущему разделу
- не раскрывает данные других компаний

---

## 6) SaaS Admin (админка владельца системы)

### 6.1 Разделы
1) **Tenants**: список компаний, edition, plan, статус, дата регистрации, активность  
2) **Billing**: подписки, лимиты, счета, оплаты, задолженность  
3) **Usage**: DAU/WAU, события, API latency/errors, активные пользователи/водители  
4) **Audit logs**: события (login, create/update/delete) с фильтрами  
5) **Feature flags**: управление фичами по компании (включение модулей)  
6) **Support tools**:
   - reset password (без просмотра секретов)
   - опционально impersonation (строго с аудитом)

### 6.2 Безопасность
- `platform_admin` не видит пароли/токены.
- Любое действие поддержки логируется (audit).

---

## 7) Лендинг (public)
- единый landing routa
- блок “Продукты” (RoutaL/T/X/…):
  - короткое описание аудитории
  - ключевые KPI/выгоды
  - кнопка “Начать” с предвыбранным продуктом
- сценарий: Landing → choose product → registration → create company → onboarding

---

# 8) Приёмка (строгая, подробная)

## 8.1 Общие условия тестирования
- Среда: локально + docker + staging (при наличии)
- Браузеры: Chrome (последний), Edge (последний)
- Разрешения: Desktop 1366×768 и 1920×1080 (минимум)
- Тестовые аккаунты:
  - Owner компании A (RoutaX, plan=pro)
  - Admin компании A
  - Driver компании A
  - Owner компании B (RoutaL, plan=start) (для multi-tenant проверки)
  - platform_admin (SaaS Admin)

## 8.2 “Блокеры” (если любой пункт не пройден — релиз запрещён)
B1. Нельзя войти/выйти/перелогиниться без очистки браузера.  
B2. Пропадают вкладки/хедер/иконки на любой странице.  
B3. Роль меняется самопроизвольно при переходе по вкладкам.  
B4. Тема не переключается или “ломает” страницу (особенно fleet).  
B5. Driver видит уведомления/данные, предназначенные для owner/admin.  
B6. Любая страница падает 5xx/502 при обычном клике пользователя.

## 8.3 Smoke-тесты (обязательны перед сдачей)

### 8.3.1 Авторизация
- S-Auth-01: Вход owner → редирект на “Флот” (или стартовую страницу по настройке продукта), роль = owner, вкладки owner-уровня.
- S-Auth-02: Выход → переход на login, токены очищены.
- S-Auth-03: Вход admin → вкладки admin-уровня, нет “Персонал”.
- S-Auth-04: Вход driver → только driver-разделы, нет бизнес-разделов.
- S-Auth-05: Перелогин: owner → logout → admin → logout → driver. Роли и вкладки каждый раз корректны, “залипания” нет.

### 8.3.2 Навигация и вкладки (для каждой роли)
- S-Nav-01: Owner видит вкладки в точном порядке (см. 1.3), на любой странице.
- S-Nav-02: Admin видит вкладки в точном порядке (см. 1.3), на любой странице.
- S-Nav-03: Переход “Флот → Рейсы → Геозоны → … → Инвентарь” выполняется без пропажи кнопок.
- S-Nav-04: На каждой странице есть иконки “Уведомления” и “Настройки”, кликабельны.

### 8.3.3 Тема
- S-Theme-01: Первая загрузка без localStorage → тема светлая (light).
- S-Theme-02: Переключить на dark на fleet → обновить страницу → dark сохранился.
- S-Theme-03: Перейти на другую вкладку (например, Рейсы) → тема сохранилась.
- S-Theme-04: Driver: тема переключается и сохраняется.

### 8.3.4 Уведомления
- S-Notif-01: Водитель: видит только свои уведомления, список виден сразу (skeleton → данные).
- S-Notif-02: Owner/Admin: видят системные уведомления.
- S-Notif-03: UI уведомлений соответствует дизайн-системе (кнопки не “квадратные”, состояния hover/focus присутствуют).

## 8.4 Ролевые регрессионные тесты (подробно)

### 8.4.1 Owner (RoutaX)
- R-Owner-01: На каждой вкладке роль в шапке = owner.
- R-Owner-02: “Персонал” доступен и не исчезает при переходах.
- R-Owner-03: “Аналитика” показывает owner-уровень (в соответствии с edition).
- R-Owner-04: Данные не “перескакивают” на admin при переходе “Рейсы/Геозоны”.

### 8.4.2 Admin (RoutaX)
- R-Admin-01: Нет вкладки “Персонал”.
- R-Admin-02: “Аналитика” урезанная (нет полной бизнес-сводки owner).
- R-Admin-03: Нет доступа к owner-only эндпоинтам (403 корректно отрабатывает).

### 8.4.3 Driver
- R-Driver-01: Нет доступа к управлению флотом/инвентарем (если так задано).
- R-Driver-02: Уведомления только личные.
- R-Driver-03: Документы только по назначенным рейсам.
- R-Driver-04: Тема переключается.

### 8.4.4 Platform Admin (SaaS Admin)
- R-Platform-01: Видит список тенантов и их edition/plan.
- R-Platform-02: Может менять feature flags компании A без влияния на компанию B.
- R-Platform-03: Audit log фиксирует изменения feature flags.

## 8.5 Нефункциональные требования (приёмка)
- NFR-01: На кликах по вкладкам нет JS ошибок в консоли.
- NFR-02: Время первой отрисовки (без кэша) целевой страницы ≤ 2.5 сек (локально/стейджинг).
- NFR-03: Все иконки/логотипы грузятся без внешних CDN.
- NFR-04: Accessibility минимум:
  - кнопки доступны с клавиатуры (Tab)
  - видимый focus
  - контраст в light/dark приемлемый
- NFR-05: Безопасность:
  - запрет доступа к данным другой компании (tenant isolation)
  - корректная обработка 401/403
  - audit для критичных действий

## 8.6 Definition of Done (DoD) для любой задачи
- Реализовано по ТЗ.
- Нет ошибок в консоли.
- Покрыто минимум smoke/e2e тестом (или чеклистом + автотест в плане).
- Работает в light/dark.
- Работает для всех ролей, которых касается.
- Соответствует дизайн-системе.

---

# 9) Таблица фич (Feature Matrix)

Обозначения:
- **Full** — доступно полностью
- **Limited** — доступно частично/ограничено
- **Optional** — опционально (фич-флаг/план)
- **N/A** — не применимо

> Матрица задаёт продуктовые границы. Реализация должна опираться на `edition + plan + features`.

| Модуль/Фича | RoutaL Start | RoutaL Pro | RoutaT Start | RoutaT Pro | RoutaX Pro | RoutaX Business | RoutaF | RoutaE | RoutaS |
|---|---:|---:|---:|---:|---:|---:|---:|---:|---:|
| Регистрация owner + создание компании | Full | Full | Full | Full | Full | Full | Full | Full | N/A |
| Join по приглашению (invite) | Full | Full | Full | Full | Full | Full | Full | Full | Full |
| Мульти-компания для пользователя | Optional | Optional | Optional | Optional | Full | Full | Full | Full | Optional |
| RBAC роли (owner/admin/driver) | Full | Full | Full | Full | Full | Full | Full | Full | Limited |
| Фич-флаги на компанию | Optional | Full | Optional | Full | Full | Full | Full | Full | Full |
| Флот (ТС, карточка) | Full | Full | Full | Full | Full | Full | N/A | Full | Limited |
| Рейсы базовые | Full | Full | Full | Full | Full | Full | Full | Full | Limited |
| Рейсы: экономика (маржа/план-факт) | N/A | Optional | N/A | Optional | Full | Full | Full | Full | N/A |
| Геозоны + триггеры | Limited | Full | Full | Full | Full | Full | Optional | Full | N/A |
| Аналитика (операционная) | Limited | Full | Full | Full | Full | Full | Full | Full | Limited |
| Аналитика (бизнес-уровень owner) | N/A | Optional | N/A | Optional | Full | Full | Optional | Full | N/A |
| Топливо (ручной учет) | Full | Full | Full | Full | Full | Full | Optional | Full | N/A |
| Топливо: аномалии/сверка | N/A | Optional | Optional | Full | Full | Full | Optional | Full | N/A |
| ТО (план/факт/уведомления) | Full | Full | Full | Full | Full | Full | Optional | Full | N/A |
| Документы (хранение/статусы) | Full | Full | Full | Full | Full | Full | Full | Full | Limited |
| Инвентарь (склад/остатки) | Optional | Full | Optional | Full | Full | Full | Optional | Full | N/A |
| Уведомления + фильтрация по ролям | Full | Full | Full | Full | Full | Full | Full | Full | Full |
| AI помощник (FAQ/подсказки) | Optional | Full | Optional | Full | Full | Full | Optional | Full | Full |
| Мобильный/PWA кабинет | Optional | Optional | Optional | Full | Optional | Full | Optional | Optional | Full |
| Интеграции GPS/ГЛОНАСС | N/A | Optional | Optional | Full | Optional | Full | Optional | Full | N/A |
| Интеграции топливные карты | N/A | Optional | Optional | Full | Optional | Full | Optional | Full | N/A |
| Интеграции 1С/ЭДО | N/A | N/A | N/A | Optional | Optional | Full | Optional | Full | N/A |
| Forwarder: подрядчики (carriers) | N/A | N/A | N/A | N/A | Optional | Optional | Full | Full | Optional |
| Enterprise: SSO (SAML/OIDC) | N/A | N/A | N/A | N/A | N/A | Optional | N/A | Full | N/A |
| Enterprise: расширенный аудит/комплаенс | N/A | N/A | N/A | N/A | Optional | Full | Optional | Full | Optional |
| SaaS Admin (platform_admin) | N/A | N/A | N/A | N/A | N/A | N/A | N/A | Full | N/A |

---

# 10) Примечания к реализации (обязательные)
1) Меню/вкладки строить не “хардкодом HTML”, а из единого источника правды: `role + features`, чтобы не ломалось на страницах.
2) Любая страница без корректной шапки/навигации считается дефектом уровня Blocker.
3) Иконки и логотипы — локальные ресурсы.
4) Любое действие “смена роли/сессии” должно приводить к корректному обновлению UI и данных без перезагрузки браузера.

---

# 11) Результаты сдачи
- Полный прогон smoke + регресс по ролям выполнен и задокументирован.
- Матрица фич реализована через edition/plan/features.
- Лендинг с выбором продукта + корректная регистрация/онбординг.
- SaaS Admin доступен и функционален для `platform_admin`.
- AI помощник видим на всех страницах и работает.
